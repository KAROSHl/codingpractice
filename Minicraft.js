function findListElement(n,t){for(var i=0;i<n.length;){if(n[i]==t)return i;i+=1}return-1}function addElementToStartOfList(n,t){var u=n.length,r=n[0],i;for(n[0]=t,t=r,i=1;i<u+1;)r=n[i],n[i]=t,t=r,i+=1}function concatenateLists(n,t){for(var i=0;i<t.length;)n.push(t[i]),i+=1}function playSound(n){var t=audioPlayerSet[n];t.currentTime=0,t.play(),timeSinceLastSound=0}function Color(n,t,i){this.r=n,this.g=t,this.b=i}function Vector(n,t){this.x=n,this.y=t,this.copy=function(){return new Vector(this.x,this.y)},this.equals=function(n){return this.x==n.x&&this.y==n.y}}function addSolidRectangle(n,t,i){var r=document.createElement("div"),u;return document.getElementById("gameDiv").appendChild(r),r.style.width=t.x*pixelSize+"px",r.style.height=t.y*pixelSize+"px",r.style.position="absolute",r.style.left=n.x*pixelSize+"px",r.style.top=n.y*pixelSize+"px",u=convertNumberIntoColor(i),r.style.background="rgb("+u.r+", "+u.g+", "+u.b+")",r}function convertNumberIntoColor(n){return colorSet[n]}function setLightingBackground(n,t){var i=lightingSet[n],r=lightingValueList[n];if(t==r)return!1;if(lightingValueList[n]=t,t==4)return i.style.display="none",!0;if(i.style.display="block",t==0)return i.style.backgroundImage="",i.style.background="black",!0;i.style.background="",i.style.backgroundImage="url(lighting.png)",i.style.backgroundPosition="-"+(t-1)*24+"px 0px"}function convertPosToLightingValueListIndex(n){return parseInt(n.x/8)+parseInt(n.y/8)*screenDim.x/8}function addLightToLightingValueList(n,t,i){for(var r=new Vector(-i-1,-i-1),f,s;r.y<i+1;){if(f=new Vector(t.x+r.x*8,t.y+r.y*8),f.x>-1&&f.x<screenDim.x&&f.y>-1&&f.y<screenDim.y-16){var u=Math.sqrt(Math.pow(r.x+.5,2)+Math.pow(r.y+.5,2)),o=convertPosToLightingValueListIndex(f),e=4;u>i&&u<=i+.25&&(e=3),u>i+.25&&u<=i+.5&&(e=2),u>i+.5&&u<=i+.75&&(e=1),u>i+.75&&(e=0),s=n[o],e>s&&(n[o]=e)}r.x+=1,r.x>i&&(r.x=-i-1,r.y+=1)}}function updateLighting(){var i,r,t,f,u,n;if(currentLevelDepth<1)for(n=0;n<lightingSet.length;)setLightingBackground(n,4),n+=1;else{for(i=[],n=0;n<lightingValueList.length;)i[n]=0,n+=1;for(n=0;n<visibleEntityList.length;)r=visibleEntityList[n],r.removed||r.isDead||(f=new Vector(r.pos.x-cameraPos.x,r.pos.y-cameraPos.y),u=r.getLightRadius(),u>0&&addLightToLightingValueList(i,f,u)),n+=1;for(n=0;n<visibleTileList.length;){if(t=visibleTileList[n],!t.removed&&(f=new Vector(t.pos.x+8-cameraPos.x,t.pos.y+8-cameraPos.y),u=t.getLightRadius(),u>0)){var e=currentLevel.getTileObject(t.pos.x+16,t.pos.y),o=currentLevel.getTileObject(t.pos.x+16,t.pos.y+16),s=currentLevel.getTileObject(t.pos.x+16,t.pos.y+16);e.getLightRadius()<0|o.getLightRadius()<0|s.getLightRadius()<0|(t.pos.x%32==0&&t.pos.y%32==0)&&addLightToLightingValueList(i,f,u)}n+=1}for(n=0;n<i.length;)setLightingBackground(n,i[n]),n+=1}}function addSprite(n,t,i,r,u){var o,f,e;return r.length!=undefined&&(r=0),i==-1&&(i=parseInt(Math.random()*4)),o=new Vector(n.x*8,n.y*8),u==!0?(f=window.frames[0].document.createElement("div"),window.frames[0].document.getElementById("body").appendChild(f)):(f=document.createElement("div"),document.getElementById("gameDiv").appendChild(f)),f.style.position="absolute",f.style.left=t.x*pixelSize+"px",f.style.top=t.y*pixelSize+"px",f.style.width=n.x*pixelSize*8+"px",f.style.height=Math.floor(n.y*pixelSize*8)+"px",e=new Vector(i%32*8,parseInt(i/32)*8),f.style.backgroundImage="url(icons"+(r+1)+".png)",f.style.backgroundPosition="-"+e.x*pixelSize+"px -"+Math.floor(e.y*pixelSize-0)+"px",f}function touchstart(n){return window.event.preventDefault(),document.keyDown(new DummyEvent(n)),!1}function touchend(n){return document.keyUp(new DummyEvent(n)),!1}function getSpritePos(n){var t=n.style.left,i=n.style.top,r=parseInt(t.substring(0,t.length-2)),u=parseInt(i.substring(0,i.length-2));return new Vector(r/pixelSize,u/pixelSize)}function setSpritePos(n,t){n.style.left=t.x*pixelSize+"px",n.style.top=t.y*pixelSize+"px"}function getSpriteDim(n){var t=n.style.width,i=n.style.height,r=parseInt(t.substring(0,t.length-2)),u=parseInt(i.substring(0,i.length-2));return new Vector(r/pixelSize/8,u/pixelSize/8)}function setSpriteDim(n,t){n.style.width=t.x*pixelSize*8+"px",n.style.height=Math.ceil(t.y*pixelSize*8)+"px"}function setSpriteType(n,t){t==-1&&(t=parseInt(Math.random()*4));var i=new Vector(t%32*8,parseInt(t/32)*8);n.style.backgroundPosition="-"+i.x*pixelSize+"px -"+i.y*pixelSize+"px"}function setSpriteColorNumberLust(n,t){t==-1?n.style.display="none":(n.style.display="block",n.style.backgroundImage="url(icons"+(t+1)+".png)")}function setSpriteColorNumberList(){}function setSpriteFlip(){}function setSpriteGroupPos(n,t){var i=getSpritePos(n[0]);moveSpriteGroup(n,new Vector(t.x-i.x,t.y-i.y))}function moveSpriteGroup(n,t){for(var r=0,u,i;r<n.length;)u=n[r],i=getSpritePos(u),i.x+=t.x,i.y+=t.y,setSpritePos(u,i),r+=1}function setSpriteGroupZIndex(n,t){for(var i=0,r;i<n.length;)r=n[i],r.style.zIndex=t,i+=1}function removeSpriteGroup(n,t){var i,f,r,u;for(i=t==!0?window.frames[0].document.getElementById("body"):document.getElementById("gameDiv"),f=i.childNodes,r=n.length-1;r>-1;)u=n[r],findListElement(f,u)>-1&&i.removeChild(u),r-=1}function removeAllSprites(n){var t,r,i,u;for(n==!0?t=window.frames[0].document.getElementById("body"):(menuOptionSpriteGroups=[],guiSpriteList=[],t=document.getElementById("gameDiv")),r=t.childNodes,i=r.length-1;i>-1;)u=r[i],u.id!="frame"&&t.removeChild(u),i-=1}function convertCharacterIntoNumber(n){return characterSet.indexOf(n)+960}function drawFont(n,t,i,r){var e=[],f,u,o,s;for(n=n.toUpperCase(),f=t.copy(),u=0;u<n.length;)o=n.substring(u,u+1),s=convertCharacterIntoNumber(o),e.push(addSprite(new Vector(1,1),f,s,i,r)),u+=1,f.x+=8;return e}function drawMenuFrame(n,t,i){var o=[],u,s,h;o.push(addSolidRectangle(new Vector(t.x+8,t.y+8),new Vector(i.x-t.x-8,i.y-t.y-8),5));for(var f=new Vector(1,1),e=[0,1,5,445],r=t.copy();r.y<i.y+1;)u=-1,r.x==t.x&&r.y==t.y&&(u=addSprite(f,r,384,e)),r.x==i.x&&r.y==t.y&&(u=addSprite(f,r,385,e)),r.x==t.x&&r.y==i.y&&(u=addSprite(f,r,416,e)),r.x==i.x&&r.y==i.y&&(u=addSprite(f,r,417,e)),s=u!=-1,s||(r.y==t.y&&(u=addSprite(f,r,387,e)),r.x==t.x&&(u=addSprite(f,r,418,e)),r.y==i.y&&(u=addSprite(f,r,386,e)),r.x==i.x&&(u=addSprite(f,r,419,e))),u!=-1&&o.push(u),r.x+=8,r.x>i.x&&(r.x=t.x,r.y+=8);return h=drawFont(n,new Vector(t.x+8,t.y),5),concatenateLists(o,h),o}function drawMenuFrameCursor(n,t){var i=[],r=new Vector(1,1),u=6;return i.push(addSprite(r,n,1017,u)),i.push(addSprite(r,t,1016,u)),i}function drawMenuFrameItemList(n,t,i){var o=[],u=9,h=0,e=t.length,r,f,s;for(e>u&&(e=u),r=i-parseInt(u/2),r>t.length-u&&(r=t.length-u),r<0&&(r=0),f=h;f<e;)s=t[f+r].drawInventory(new Vector(n.x,f*8+n.y)),o.push(s),f+=1;return o}function moveMenuFrameCursor(n,t){var h=0,o=!1,f,e,c,r,u,s,i;if(currentMenuFrameCursorIndex+=t,f=currentMenuFrameObjectList.length,currentMenuFrameCursorIndex>f-1&&(currentMenuFrameCursorIndex=0,o=!0),currentMenuFrameCursorIndex<0&&(currentMenuFrameCursorIndex=f-1,o=!0),e=currentMenuFrameCursorIndex,f>9?currentMenuFrameCursorIndex>4&&(e=currentMenuFrameCursorIndex>f-5?9+currentMenuFrameCursorIndex-f:4):o=!1,e<0&&(e=0),c=getSpritePos(currentMenuFrameCursor[0]),u=new Vector(n.x,n.y+e*8),setSpriteGroupPos(currentMenuFrameCursor,u),o){for(r=0;r<currentMenuFrameInfoList.length;)i=currentMenuFrameInfoList[r],removeSpriteGroup(i),r+=1;u=new Vector(n.x+8,n.y),currentMenuFrameInfoList=drawMenuFrameItemList(u,currentMenuFrameObjectList,currentMenuFrameCursorIndex)}else if(c.y==u.y&&f!=1)for(h=-t*8,r=0;r<currentMenuFrameInfoList.length;)i=currentMenuFrameInfoList[r],moveSpriteGroup(i,new Vector(0,h)),u=getSpritePos(i[0]),u.y<n.y&&(removeSpriteGroup(i),s=currentMenuFrameObjectList[currentMenuFrameCursorIndex+4],i=s.drawInventory(new Vector(n.x+8,n.y+64)),currentMenuFrameInfoList[r]=i),u.y>n.y+64&&(removeSpriteGroup(i),s=currentMenuFrameObjectList[currentMenuFrameCursorIndex-4],i=s.drawInventory(new Vector(n.x+8,n.y)),currentMenuFrameInfoList[r]=i),r+=1}function redrawSecondaryMenuFrameInfo(){for(var f=0,e,t,n,o,u,i,s;f<secondaryMenuFrameInfoList.length;)removeSpriteGroup(secondaryMenuFrameInfoList[f]),f+=1;if(secondaryMenuFrameInfoList=[],gameState==5|gameState==6|gameState==7|gameState==8){var h=currentMenuFrameObjectList[currentMenuFrameCursorIndex],n=h.resultTemplate,c=currentPlayer.inventory.count(n),r=104;for(secondaryMenuFrameInfoList.push([n.draw(new Vector(r,16))]),secondaryMenuFrameInfoList.push(drawFont(""+c,new Vector(r+8,16),0)),e=h.costs,t=0;t<e.length;)n=e[t],o=(5+t)*8,secondaryMenuFrameInfoList.push([n.draw(new Vector(r,o))]),u=1,n.resource!=undefined&&(u=n.count),i=currentPlayer.inventory.count(n),s=i<u?2:0,i>99&&(i=99),secondaryMenuFrameInfoList.push(drawFont(""+u+"/"+i,new Vector(r+8,o),s)),t+=1}gameState==9&&(secondaryMenuFrameInfoList=currentMenuFramePosition==0?drawMenuFrameItemList(new Vector(112,16),secondaryMenuFrameObjectList,0):drawMenuFrameItemList(new Vector(-32,16),secondaryMenuFrameObjectList,0))}function redrawCurrentMenuFrameInfo(){for(var n=0;n<currentMenuFrameInfoList.length;)removeSpriteGroup(currentMenuFrameInfoList[n]),n+=1;gameState==9&&(currentMenuFrameInfoList=currentMenuFramePosition==0?drawMenuFrameItemList(new Vector(16,16),currentMenuFrameObjectList,currentMenuFrameCursorIndex):drawMenuFrameItemList(new Vector(64,16),currentMenuFrameObjectList,currentMenuFrameCursorIndex))}function swapSecondaryMenuFrame(){var i=currentMenuFramePosition,r=currentMenuFrameObjectList,n,t,u;for(currentMenuFrameObjectList=secondaryMenuFrameObjectList,secondaryMenuFrameObjectList=r,n=0;n<currentMenuFrameInfoList.length;)removeSpriteGroup(currentMenuFrameInfoList[n]),n+=1;t=getSpritePos(currentMenuFrameCursor[0]),i==0&&(moveSpriteGroup(currentMenuFrame,new Vector(-48,0)),moveSpriteGroup(currentMenuFrameCursor,new Vector(48,16-t.y)),currentMenuFramePosition=1),i==1&&(moveSpriteGroup(currentMenuFrame,new Vector(48,0)),moveSpriteGroup(currentMenuFrameCursor,new Vector(-48,16-t.y)),currentMenuFramePosition=0),redrawCurrentMenuFrameInfo(),redrawSecondaryMenuFrameInfo(),currentMenuFrameCursorIndex=0}function inheritFromClass(n,t){var i;for(i in new t)n.prototype[i]=(new t)[i]}function dropResource(n,t,i,r){for(var u=parseInt(Math.random()*r)+i;u>0;)currentLevel.add(new ItemEntity(new ResourceItem(resourceSet[t]),n)),u-=1}function VisibleTile(n){this.pos=new Vector(parseInt(n.x/16)*16,parseInt(n.y/16)*16),this.tile=currentLevel.getTileObject(this.pos),this.spriteGroup=[],this.draw=function(){this.spriteGroup=this.tile.draw(this.pos),this.updateSprites()},this.updateSprites=function(){this.tile.updateSprites(this.pos,this.spriteGroup)},this.remove=function(n){if(n==undefined)for(n=0;n<visibleTileList.length;){if(visibleTileList[n]==this)break;n+=1}n<visibleTileList.length&&visibleTileList.splice(n,1),removeSpriteGroup(this.spriteGroup,!0),currentLevel.setVisibleTile(this.pos,-1)},this.getLightRadius=function(){return this.tile.getLightRadius()},this.onscreenTick=function(){this.tile.onscreenTick(this.pos,this.spriteGroup)},this.draw(),setSpriteGroupZIndex(this.spriteGroup,0),visibleTileList.push(this),currentLevel.setVisibleTile(this.pos,this)}function Tile(){this.id=-1,this.connectsToGrass=!1,this.connectsToSand=!1,this.connectsToLava=!1,this.connectsToWater=!1,this.draw=function(){return!1},this.updateSprites=function(){return!1},this.getLightRadius=function(){return 0},this.tick=function(){return!1},this.onscreenTick=function(){return!1},this.swap=function(n,t){currentLevel.changeTile(n,t)},this.connectsToLiquid=function(){return this.connectsToWater||this.connectsToLava},this.hurt=function(){return!1},this.mayPass=function(){return!0},this.bumpedInto=function(){return!1},this.steppedOn=function(){return!1},this.interact=function(){return!1}}function getOrthogonalNeighbors(n){var i=[],t;return t=new Vector(n.x,n.y-16),i.push(currentLevel.getTileObject(t)),t=new Vector(n.x,n.y+16),i.push(currentLevel.getTileObject(t)),t=new Vector(n.x-16,n.y),i.push(currentLevel.getTileObject(t)),t=new Vector(n.x+16,n.y),i.push(currentLevel.getTileObject(t)),i}function getAllNeighbors(n){var i=getOrthogonalNeighbors(n),t;return t=new Vector(n.x-16,n.y-16),i.push(currentLevel.getTileObject(t)),t=new Vector(n.x-16,n.y+16),i.push(currentLevel.getTileObject(t)),t=new Vector(n.x+16,n.y-16),i.push(currentLevel.getTileObject(t)),t=new Vector(n.x+16,n.y+16),i.push(currentLevel.getTileObject(t)),i}function addSpriteQuadruplet(n){var t=[];return t.push(addSprite(new Vector(1,1),n,0,[1,1,1,1],!0)),t.push(addSprite(new Vector(1,1),new Vector(n.x+8,n.y),0,[1,1,1,1],!0)),t.push(addSprite(new Vector(1,1),new Vector(n.x,n.y+8),0,[1,1,1,1],!0)),t.push(addSprite(new Vector(1,1),new Vector(n.x+8,n.y+8),0,[1,1,1,1],!0)),t}function BoundaryTile(){this.connectsToLava=!0,this.connectsToWater=!0,this.mayPass=function(){return!1}}function CactusTile(){this.id=7,this.connectsToSand=!0,this.mayPass=function(){return!1},this.bumpedInto=function(n,t){t.hurtFromTile(this,n,1)},this.hurt=function(n,t){var u=new Vector(n.x+8,n.y+8),r;currentLevel.add(new TextParticle(""+t,u.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(u)),r=currentLevel.getTileData(n),r+=t,currentLevel.setTileData(n,r),r>=10&&(this.swap(n,6),u=new Vector(n.x+8,n.y+8),dropResource(u,6,1,2))},this.draw=function(n){var t=[],i=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return t.push(addSprite(new Vector(2,2),i,0,[1,1,1,1],!0)),t},this.updateSprites=function(n,t){setSpriteType(t[0],72)}}function GrassTile(){this.id=0,this.connectsToGrass=!0,this.tick=function(n){var t,i,r;if(Math.random()<.5)return!1;t=n.x,i=n.y,Math.random()<.5?t+=parseInt(Math.random()*2)*32-16:i+=parseInt(Math.random()*2)*32-16,r=new Vector(t,i),currentLevel.getTileId(r)==5&&currentLevel.changeTile(r,0)},this.interact=function(n,t){var r;if(t.getAttackDamageBonus!=undefined){if(t.type==toolTypeSet[0]&&currentPlayer.payStamina(4-t.level))return playSound(3),Math.random()<.2&&(r=new Vector(n.x+8,n.y+8),currentLevel.add(new ItemEntity(new ResourceItem(resourceSet[7]),r))),this.swap(n,5),!0;if(t.type==toolTypeSet[1]&&currentPlayer.payStamina(4-t.level))return playSound(3),Math.random()<.2&&(r=new Vector(n.x+8,n.y+8),currentLevel.add(new ItemEntity(new ResourceItem(resourceSet[7]),r))),this.swap(n,11),!0}return!1},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var i=getOrthogonalNeighbors(n),u=0,r;u<i.length;)i[u]=!i[u].connectsToGrass,u+=1;r=t[0],i[0]||i[2]?setSpriteType(r,(i[2]?11:12)+(i[0]?0:1)*32):setSpriteType(r,0),r=t[1],i[0]||i[3]?setSpriteType(r,(i[3]?13:12)+(i[0]?0:1)*32):setSpriteType(r,1),r=t[2],i[1]||i[2]?setSpriteType(r,(i[2]?11:12)+(i[1]?2:1)*32):setSpriteType(r,2),r=t[3],i[1]||i[3]?setSpriteType(r,(i[3]?13:12)+(i[1]?2:1)*32):setSpriteType(r,3)}}function RockTile(){this.id=1,this.mayPass=function(){return!1},this.interact=function(n,t){return t.getAttackDamageBonus!=undefined&&t.type==toolTypeSet[3]&&currentPlayer.payStamina(4-t.level)?(this.hurt(n,parseInt(Math.random()*10)+t.level*5+10),!0):!1},this.hurt=function(n,t){var r=new Vector(n.x+8,n.y+8),u;currentLevel.add(new TextParticle(""+t,r.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(r)),u=currentLevel.getTileData(n),u+=t,currentLevel.setTileData(n,u),u>=50&&(this.swap(n,5),r=new Vector(n.x+8,n.y+8),dropResource(r,1,1,4),dropResource(r,11,0,2))},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var f=3,u=0,r=getAllNeighbors(n),e=0,i;e<r.length;)r[e]=r[e].id!=this.id,e+=1;i=t[0],r[0]||r[2]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[2]?4:5)+(r[0]?0:1)*32)):r[4]?(setSpriteColorNumberLust(i,u),setSpriteType(i,40)):(setSpriteColorNumberLust(i,f),setSpriteType(i,0)),i=t[1],r[0]||r[3]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[3]?6:5)+(r[0]?0:1)*32)):r[6]?(setSpriteColorNumberLust(i,u),setSpriteType(i,39)):(setSpriteColorNumberLust(i,f),setSpriteType(i,1)),i=t[2],r[1]||r[2]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[2]?4:5)+(r[1]?2:1)*32)):r[5]?(setSpriteColorNumberLust(i,u),setSpriteType(i,8)):(setSpriteColorNumberLust(i,f),setSpriteType(i,2)),i=t[3],r[1]||r[3]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[3]?6:5)+(r[1]?2:1)*32)):r[7]?(setSpriteColorNumberLust(i,u),setSpriteType(i,7)):(setSpriteColorNumberLust(i,f),setSpriteType(i,3))}}function SandTile(){this.id=6,this.connectsToSand=!0,this.steppedOn=function(n,t){if(t.health!=undefined){currentLevel.setTileData(n,6/frameRate);var i=currentLevel.getVisibleTile(n);i!=-1&&i.updateSprites()}},this.tick=function(n){var t=currentLevel.getTileData(n),i;t-=1,currentLevel.setTileData(n,t),t<0&&(i=currentLevel.getVisibleTile(n),i!=-1&&i.updateSprites())},this.interact=function(n,t){if(t.getAttackDamageBonus!=undefined&&t.type==toolTypeSet[0]&&currentPlayer.payStamina(4-t.level)){playSound(3);var r=new Vector(n.x+8,n.y+8);return currentLevel.add(new ItemEntity(new ResourceItem(resourceSet[5]),r)),this.swap(n,5),!0}return!1},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var u=1,f=1,r=getOrthogonalNeighbors(n),e=0,o,i;e<r.length;)r[e]=!r[e].connectsToSand,e+=1;o=currentLevel.getTileData(n),i=t[0],r[0]||r[2]?(setSpriteColorNumberLust(i,f),setSpriteType(i,(r[2]?11:12)+(r[0]?0:1)*32)):o>0?(setSpriteColorNumberLust(i,0),setSpriteType(i,35)):(setSpriteColorNumberLust(i,u),setSpriteType(i,0)),i=t[1],r[0]||r[3]?(setSpriteColorNumberLust(i,f),setSpriteType(i,(r[3]?13:12)+(r[0]?0:1)*32)):(setSpriteColorNumberLust(i,u),setSpriteType(i,1)),i=t[2],r[1]||r[2]?(setSpriteColorNumberLust(i,f),setSpriteType(i,(r[2]?11:12)+(r[1]?2:1)*32)):(setSpriteColorNumberLust(i,u),setSpriteType(i,2)),i=t[3],r[1]||r[3]?(setSpriteColorNumberLust(i,f),setSpriteType(i,(r[3]?13:12)+(r[1]?2:1)*32)):o>0?(setSpriteColorNumberLust(i,0),setSpriteType(i,35)):(setSpriteColorNumberLust(i,u),setSpriteType(i,3))}}function WaterTile(){this.id=2,this.fillDelay=0,this.connectsToSand=!0,this.connectsToWater=!0,this.mayPass=function(n,t){return t.canSwim()},this.tick=function(n){var i=currentLevel.getTileData(n),u,r,t;if(i<1)for(u=[new Vector(n.x-16,n.y),new Vector(n.x+16,n.y),new Vector(n.x,n.y-16),new Vector(n.x,n.y+16)],r=0;r<u.length;)t=u[r],currentLevel.getTileId(t)==8&&(currentLevel.changeTile(t,2),t.x>n.x|t.y>n.y&&currentLevel.setTileData(t,1)),r+=1;i>-1&&(i-=1,currentLevel.setTileData(n,i))},this.onscreenTick=function(n,t){return Math.random()<.5/frameRate&&this.updateSprites(n,t),!1},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var e=2,o=2,s=3,i=getOrthogonalNeighbors(n),u=[],f=0,h,r;f<i.length;)h=i[f],u[f]=h.connectsToSand&&!h.connectsToWater,f+=1;for(f=0;f<i.length;)i[f]=!i[f].connectsToWater,f+=1;r=t[0],i[0]||i[2]?(setSpriteColorNumberLust(r,u[0]||u[2]?s:o),setSpriteType(r,(i[2]?14:15)+(i[0]?0:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,parseInt(Math.random()*4))),r=t[1],i[0]||i[3]?(setSpriteColorNumberLust(r,u[0]||u[3]?s:o),setSpriteType(r,(i[3]?16:15)+(i[0]?0:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,parseInt(Math.random()*4))),r=t[2],i[1]||i[2]?(setSpriteColorNumberLust(r,u[1]||u[2]?s:o),setSpriteType(r,(i[2]?14:15)+(i[1]?2:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,parseInt(Math.random()*4))),r=t[3],i[1]||i[3]?(setSpriteColorNumberLust(r,u[1]||u[3]?s:o),setSpriteType(r,(i[3]?16:15)+(i[1]?2:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,parseInt(Math.random()*4)))}}function FlowerTile(){this.id=3,this.connectsToGrass=!0,this.hurt=function(n){this.swap(n,0);var r=new Vector(n.x+8,n.y+8);dropResource(r,2,1,2)},this.draw=function(n){currentLevel.setTileData(n,parseInt(Math.random()*2));var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var i=getOrthogonalNeighbors(n),f=0,u,r;f<i.length;)i[f]=!i[f].connectsToGrass,f+=1;u=currentLevel.getTileData(n),r=t[0],u==0?i[0]||i[2]?setSpriteType(r,(i[2]?11:12)+(i[0]?0:1)*32):setSpriteType(r,0):setSpriteType(r,33),r=t[1],u==1?i[0]||i[3]?setSpriteType(r,(i[3]?13:12)+(i[0]?0:1)*32):setSpriteType(r,1):setSpriteType(r,33),r=t[2],u==1?i[1]||i[2]?setSpriteType(r,(i[2]?11:12)+(i[1]?2:1)*32):setSpriteType(r,2):setSpriteType(r,33),r=t[3],u==0?i[1]||i[3]?setSpriteType(r,(i[3]?13:12)+(i[1]?2:1)*32):setSpriteType(r,3):setSpriteType(r,33)}}function TreeTile(){this.id=4,this.connectsToGrass=!0,this.mayPass=function(){return!1},this.interact=function(n,t){return t.getAttackDamageBonus!=undefined&&t.type==toolTypeSet[4]&&currentPlayer.payStamina(4-t.level)?(this.hurt(n,parseInt(Math.random()*10)+t.level*5+10),!0):!1},this.hurt=function(n,t){var r=new Vector(n.x+8,n.y+8),u;Math.random()<.1&&dropResource(r,10,1,0),currentLevel.add(new TextParticle(""+t,r.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(r)),u=currentLevel.getTileData(n),u+=t,currentLevel.setTileData(n,u),u>=20&&(this.swap(n,0),r=new Vector(n.x+8,n.y+8),dropResource(r,0,1,2),dropResource(r,3,1,4))},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var i=getAllNeighbors(n),u=0,r;u<i.length;)i[u]=i[u].id==this.id,u+=1;r=t[0],i[0]&&i[2]&&i[4]?setSpriteType(r,42):setSpriteType(r,9),r=t[1],i[0]&&i[3]&&i[6]?setSpriteType(r,74):setSpriteType(r,10),r=t[2],i[1]&&i[2]&&i[5]?setSpriteType(r,74):setSpriteType(r,41),r=t[3],i[1]&&i[3]&&i[7]?setSpriteType(r,42):setSpriteType(r,106)}}function DirtTile(){this.id=5,this.interact=function(n,t){if(t.getAttackDamageBonus!=undefined){if(t.type==toolTypeSet[0]&&currentPlayer.payStamina(4-t.level)){playSound(3);var r=new Vector(n.x+8,n.y+8);return currentLevel.add(new ItemEntity(new ResourceItem(resourceSet[4]),r)),this.swap(n,8),!0}if(t.type==toolTypeSet[1]&&currentPlayer.payStamina(4-t.level))return playSound(3),this.swap(n,11),!0}return!1},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var u=7,i=0,r;i<4;)r=t[i],setSpriteColorNumberLust(r,u),setSpriteType(r,i),i+=1}}function HoleTile(){this.id=8,this.connectsToSand=!0,this.connectsToWater=!0,this.connectsToLava=!0,this.mayPass=function(n,t){return t==currentPlayer},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var e=5,o=0,s=1,i=getOrthogonalNeighbors(n),u=[],f=0,h,r;f<i.length;)h=i[f],u[f]=h.connectsToSand&&!h.connectsToLiquid(),f+=1;for(f=0;f<i.length;)i[f]=!i[f].connectsToLiquid(),f+=1;r=t[0],i[0]||i[2]?(setSpriteColorNumberLust(r,u[0]||u[2]?s:o),setSpriteType(r,(i[2]?14:15)+(i[0]?0:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,0)),r=t[1],i[0]||i[3]?(setSpriteColorNumberLust(r,u[0]||u[3]?s:o),setSpriteType(r,(i[3]?16:15)+(i[0]?0:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,0)),r=t[2],i[1]||i[2]?(setSpriteColorNumberLust(r,u[1]||u[2]?s:o),setSpriteType(r,(i[2]?14:15)+(i[1]?2:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,0)),r=t[3],i[1]||i[3]?(setSpriteColorNumberLust(r,u[1]||u[3]?s:o),setSpriteType(r,(i[3]?16:15)+(i[1]?2:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,0))}}function TreeSaplingTile(){this.id=9,this.connectsToGrass=!0,this.hurt=function(n){this.swap(n,0)},this.tick=function(n){var t=currentLevel.getTileData(n);t+=1,currentLevel.setTileData(n,t),t>8&&this.swap(n,4)},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y),i=addSpriteQuadruplet(t);return i.push(addSprite(new Vector(1,1),new Vector(t.x+4,t.y+4),0,[1,1,1,0],!0)),i},this.updateSprites=function(n,t){tileObjectSet[0].updateSprites(n,t);var i=t[4];setSpriteType(i,107)}}function CactusSaplingTile(){this.id=10,this.age=0,this.connectsToSand=!0,this.hurt=function(n){this.swap(n,6)},this.tick=function(n){var t=currentLevel.getTileData(n);t+=1,currentLevel.setTileData(n,t),t>8&&this.swap(n,7)},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y),i=addSpriteQuadruplet(t);return i.push(addSprite(new Vector(1,1),new Vector(t.x+4,t.y+4),0,[1,1,1,0],!0)),i},this.updateSprites=function(n,t){tileObjectSet[6].updateSprites(n,t);var i=t[4];setSpriteType(i,107)}}function FarmTile(){this.id=11,this.steppedOn=function(n,t){t.health!=undefined&&Math.random()<.05&&this.swap(n,5)},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var i=0,u,r;i<4;)u=t[i],r=0,i==0|i==3&&(r=74),setSpriteType(u,2+r+32),i+=1}}function WheatTile(){this.id=12,this.steppedOn=function(n,t){t.health!=undefined&&Math.random()<.05&&this.hurt(n,1,0)},this.tick=function(n){var t=currentLevel.getTileData(n),i,r;t+=10,i=!1,t>50&&(t=50,i=!0),currentLevel.setTileData(n,t),t<50|i&&(r=currentLevel.getVisibleTile(n),r!=-1&&r.updateSprites())},this.hurt=function(n){var f=currentLevel.getTileData(n),r=new Vector(n.x+8,n.y+8),u;this.swap(n,5),r=r.copy(),dropResource(r,7,1,2),u=0,f==50?u=parseInt(Math.random()*3)+2:this.age>=40&&(u=parseInt(Math.random()*2)+1),dropResource(r,8,u,0)},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){var o=currentLevel.getTileData(n),r,u=parseInt(o/10),i,f,e;for(u>=3?(r=o>49?2:u-3,u=3):r=0,i=0;i<4;)f=t[i],setSpriteColorNumberLust(f,r),e=0,i==2|i==3&&(e=9),setSpriteType(f,4+e+96+u),i+=1}}function LavaTile(){this.id=13,this.connectsToSand=!0,this.connectsToLava=!0,this.mayPass=function(n,t){return t.canSwim()},this.getLightRadius=function(){return 6},this.tick=function(n){var i=currentLevel.getTileData(n),u,r,t;if(i<1)for(u=[new Vector(n.x-16,n.y),new Vector(n.x+16,n.y),new Vector(n.x,n.y-16),new Vector(n.x,n.y+16)],r=0;r<u.length;)t=u[r],currentLevel.getTileId(t)==8&&(currentLevel.changeTile(t,13),t.x>n.x|t.y>n.y&&currentLevel.setTileData(t,1)),r+=1;i>-1&&(i-=1,currentLevel.setTileData(n,i))},this.onscreenTick=function(n,t){return Math.random()<.5/frameRate&&this.updateSprites(n,t),!1},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var e=4,o=4,s=5,i=getOrthogonalNeighbors(n),u=[],f=0,h,r;f<i.length;)h=i[f],u[f]=h.connectsToSand&&!h.connectsToLava,f+=1;for(f=0;f<i.length;)i[f]=!i[f].connectsToLava,f+=1;r=t[0],i[0]||i[2]?(setSpriteColorNumberLust(r,u[0]||u[2]?s:o),setSpriteType(r,(i[2]?14:15)+(i[0]?0:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,parseInt(Math.random()*4))),r=t[1],i[0]||i[3]?(setSpriteColorNumberLust(r,u[0]||u[3]?s:o),setSpriteType(r,(i[3]?16:15)+(i[0]?0:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,parseInt(Math.random()*4))),r=t[2],i[1]||i[2]?(setSpriteColorNumberLust(r,u[1]||u[2]?s:o),setSpriteType(r,(i[2]?14:15)+(i[1]?2:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,parseInt(Math.random()*4))),r=t[3],i[1]||i[3]?(setSpriteColorNumberLust(r,u[1]||u[3]?s:o),setSpriteType(r,(i[3]?16:15)+(i[1]?2:1)*32)):(setSpriteColorNumberLust(r,e),setSpriteType(r,parseInt(Math.random()*4)))}}function StairsDownTile(){this.id=14,this.draw=function(n){var t=[],i=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return t.push(addSprite(new Vector(2,2),i,0,[1,1,1,1],!0)),t},this.updateSprites=function(n,t){setSpriteType(t[0],64)}}function StairsUpTile(){this.id=15,this.draw=function(n){var t=[],i=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return t.push(addSprite(new Vector(2,2),i,0,[1,1,1,1],!0)),t},this.updateSprites=function(n,t){setSpriteType(t[0],66)}}function InfiniteFallTile(){this.id=16,this.mayPass=function(n,t){return t==currentAirWizard},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var i=0,r;i<4;)r=t[i],setSpriteColorNumberLust(r,6),setSpriteType(r,i),i+=1}}function CloudTile(){this.id=17,this.interact=function(n,t){if(t.getAttackDamageBonus!=undefined&&t.type==toolTypeSet[0]&&currentPlayer.payStamina(4-t.level)){var r=new Vector(n.x+8,n.y+8);return dropResource(r,19,1,2),!0}return!1},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var f=0,u=1,r=getAllNeighbors(n),e=0,i;e<r.length;)r[e]=r[e].id==16,e+=1;i=t[0],r[0]||r[2]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[2]?4:5)+(r[0]?0:1)*32)):r[4]?(setSpriteColorNumberLust(i,u),setSpriteType(i,40)):(setSpriteColorNumberLust(i,f),setSpriteType(i,17)),i=t[1],r[0]||r[3]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[3]?6:5)+(r[0]?0:1)*32)):r[6]?(setSpriteColorNumberLust(i,u),setSpriteType(i,39)):(setSpriteColorNumberLust(i,f),setSpriteType(i,18)),i=t[2],r[1]||r[2]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[2]?4:5)+(r[1]?2:1)*32)):r[5]?(setSpriteColorNumberLust(i,u),setSpriteType(i,8)):(setSpriteColorNumberLust(i,f),setSpriteType(i,20)),i=t[3],r[1]||r[3]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[3]?6:5)+(r[1]?2:1)*32)):r[7]?(setSpriteColorNumberLust(i,u),setSpriteType(i,7)):(setSpriteColorNumberLust(i,f),setSpriteType(i,19))}}function HardRockTile(){this.id=18,this.mayPass=function(){return!1},this.interact=function(n,t){if(t.getAttackDamageBonus!=undefined&&t.type==toolTypeSet[3]&&t.level==4&&currentPlayer.payStamina(4-t.level))return this.hurtFromTool(n,parseInt(Math.random()*10)+t.level*5+10),!0},this.hurtFromTool=function(n,t){var r=new Vector(n.x+8,n.y+8),i;currentLevel.add(new TextParticle(""+t,r.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(r)),i=currentLevel.getTileData(n),i+=t,currentLevel.setTileData(n,i),i>=200&&this.swap(n,5)},this.hurt=function(n){this.hurtFromTool(n,0)},this.draw=function(n){var t=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return addSpriteQuadruplet(t)},this.updateSprites=function(n,t){for(var f=2,u=2,r=getAllNeighbors(n),e=0,i;e<r.length;)r[e]=r[e].id!=this.id,e+=1;i=t[0],r[0]||r[2]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[2]?4:5)+(r[0]?0:1)*32)):r[4]?(setSpriteColorNumberLust(i,u),setSpriteType(i,40)):(setSpriteColorNumberLust(i,f),setSpriteType(i,0)),i=t[1],r[0]||r[3]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[3]?6:5)+(r[0]?0:1)*32)):r[6]?(setSpriteColorNumberLust(i,u),setSpriteType(i,39)):(setSpriteColorNumberLust(i,f),setSpriteType(i,1)),i=t[2],r[1]||r[2]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[2]?4:5)+(r[1]?2:1)*32)):r[5]?(setSpriteColorNumberLust(i,u),setSpriteType(i,8)):(setSpriteColorNumberLust(i,f),setSpriteType(i,2)),i=t[3],r[1]||r[3]?(setSpriteColorNumberLust(i,u),setSpriteType(i,(r[3]?6:5)+(r[1]?2:1)*32)):r[7]?(setSpriteColorNumberLust(i,u),setSpriteType(i,7)):(setSpriteColorNumberLust(i,f),setSpriteType(i,3))}}function IronOreTile(){this.id=21,this.mayPass=function(){return!1},this.bumpedInto=function(n,t){t.hurtFromTile(this,n,3)},this.interact=function(n,t){if(t.getAttackDamageBonus!=undefined&&t.type==toolTypeSet[3]&&currentPlayer.payStamina(6-t.level))return this.hurtFromTool(n,1),!0},this.hurt=function(n){var r=new Vector(n.x+8,n.y+8);currentLevel.add(new TextParticle("0",r.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(r))},this.hurtFromTool=function(n,t){var i=new Vector(n.x+8,n.y+8),r;currentLevel.add(new TextParticle(""+t,i.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(i)),r=currentLevel.getTileData(n),r+=1,currentLevel.setTileData(n,r),dropResource(i,12,0,2),r>parseInt(Math.random()*10)+3&&(this.swap(n,5),i=new Vector(n.x+8,n.y+8),dropResource(i,12,2,0))},this.draw=function(n){var t=[],i=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return t.push(addSprite(new Vector(2,2),i,0,[1,1,1,1],!0)),t},this.updateSprites=function(n,t){var i=0;setSpriteColorNumberLust(t[0],i),setSpriteType(t[0],49)}}function GoldOreTile(){this.id=21,this.mayPass=function(){return!1},this.bumpedInto=function(n,t){t.hurtFromTile(this,n,3)},this.interact=function(n,t){if(t.getAttackDamageBonus!=undefined&&t.type==toolTypeSet[3]&&currentPlayer.payStamina(6-t.level))return this.hurtFromTool(n,1),!0},this.hurt=function(n){var r=new Vector(n.x+8,n.y+8);currentLevel.add(new TextParticle("0",r.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(r))},this.hurtFromTool=function(n,t){var i=new Vector(n.x+8,n.y+8),r;currentLevel.add(new TextParticle(""+t,i.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(i)),r=currentLevel.getTileData(n),r+=1,currentLevel.setTileData(n,r),dropResource(i,13,0,2),r>parseInt(Math.random()*10)+3&&(this.swap(n,5),i=new Vector(n.x+8,n.y+8),dropResource(i,13,2,0))},this.draw=function(n){var t=[],i=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return t.push(addSprite(new Vector(2,2),i,0,[1,1,1,1],!0)),t},this.updateSprites=function(n,t){var i=1;setSpriteColorNumberLust(t[0],1),setSpriteType(t[0],49)}}function GemOreTile(){this.id=21,this.mayPass=function(){return!1},this.bumpedInto=function(n,t){t.hurtFromTile(this,n,3)},this.interact=function(n,t){if(t.getAttackDamageBonus!=undefined&&t.type==toolTypeSet[3]&&currentPlayer.payStamina(6-t.level))return this.hurtFromTool(n,1),!0},this.hurt=function(n){var r=new Vector(n.x+8,n.y+8);currentLevel.add(new TextParticle("0",r.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(r))},this.hurtFromTool=function(n,t){var i=new Vector(n.x+8,n.y+8),r;currentLevel.add(new TextParticle(""+t,i.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(i)),r=currentLevel.getTileData(n),r+=1,currentLevel.setTileData(n,r),dropResource(i,20,0,2),r>parseInt(Math.random()*10)+3&&(this.swap(n,5),i=new Vector(n.x+8,n.y+8),dropResource(i,20,2,0))},this.draw=function(n){var t=[],i=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return t.push(addSprite(new Vector(2,2),i,0,[1,1,1,1],!0)),t},this.updateSprites=function(n,t){var i=2;setSpriteColorNumberLust(t[0],i),setSpriteType(t[0],49)}}function CloudCactusTile(){this.id=22,this.mayPass=function(n,t){return t==currentAirWizard},this.bumpedInto=function(n,t){t!=currentAirWizard&&t.hurtFromTile(this,n,3)},this.interact=function(n,t){if(t.getAttackDamageBonus!=undefined&&t.type==toolTypeSet[3]&&currentPlayer.payStamina(6-t.level))return this.hurtFromTool(n,1),!0},this.hurt=function(n){var r=new Vector(n.x+8,n.y+8);currentLevel.add(new TextParticle("0",r.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(r))},this.hurtFromTool=function(n,t){var r=new Vector(n.x+8,n.y+8),i;currentLevel.add(new TextParticle(""+t,r.copy(),4)),playSound(3),currentLevel.add(new SmashParticle(r)),i=currentLevel.getTileData(n),i+=1,currentLevel.setTileData(n,i),i>=10&&this.swap(n,17)},this.draw=function(n){var t=[],i=new Vector(n.x-cameraPos.x,n.y-cameraPos.y);return t.push(addSprite(new Vector(2,2),i,0,[1,1,1,1],!0)),t},this.updateSprites=function(n,t){var i=3;setSpriteColorNumberLust(t[0],i),setSpriteType(t[0],49)}}function convertPosIntoLevelIndex(n){return parseInt(n.x/16)+parseInt(n.y/16)*levelDim.x}function posIsInLevel(n){return n.x>-1&&n.y>-1&&n.x<levelDim.x*16&&n.y<levelDim.y*16}function Level(n,t,i){var u,f,e,r;for(this.tileIdList=n,this.tileDataList=[],this.visibleTileList=[],this.entities=[],this.entitiesInTiles=[],this.depth=t,u=0,f=new Vector(0,0);u<levelDim.x*levelDim.y;)e=this.tileIdList[u],this.visibleTileList[u]=-1,this.tileDataList[u]=0,this.entitiesInTiles[u]=[],u+=1,f.x+=16,f.x>(levelDim.x-1)*16&&(f.x=0,f.y+=16);if(this.getTileId=function(n){if(!posIsInLevel(n))return-1;var t=convertPosIntoLevelIndex(n);return this.tileIdList[t]},this.setTileId=function(n,t){if(!posIsInLevel(n))return!1;var i=convertPosIntoLevelIndex(n);this.tileIdList[i]=t},this.getTileData=function(n){if(!posIsInLevel(n))return-1;var t=convertPosIntoLevelIndex(n);return this.tileDataList[t]},this.setTileData=function(n,t){if(!posIsInLevel(n))return!1;var i=convertPosIntoLevelIndex(n);this.tileDataList[i]=t},this.getVisibleTile=function(n){if(!posIsInLevel(n))return-1;var t=convertPosIntoLevelIndex(n);return this.visibleTileList[t]},this.setVisibleTile=function(n,t){if(!posIsInLevel(n))return!1;var i=convertPosIntoLevelIndex(n);this.visibleTileList[i]=t},this.getTileObject=function(n){var t=this.getTileId(n);return tileObjectSet[t]},this.changeTile=function(n,t){var r,i,f,u;if(!posIsInLevel(n))return!1;for(r=this.getVisibleTile(n),this.setTileId(n,t),this.setTileData(n,0),r!=-1&&(r.remove(),new VisibleTile(n)),i=new Vector(-16,-16);i.y<32;)i.x!=0|i.y!=0&&(f=new Vector(n.x+i.x,n.y+i.y),u=this.getVisibleTile(f),u!=-1&&u.updateSprites()),i.x+=16,i.x>16&&(i.x=-16,i.y+=16)},this.addEntityToTile=function(n){if(!posIsInLevel(n.pos))return!1;var t=convertPosIntoLevelIndex(n.pos);this.entitiesInTiles[t].push(n)},this.removeEntityFromTile=function(n){if(!posIsInLevel(n.pos))return!1;var r=convertPosIntoLevelIndex(n.pos),t=this.entitiesInTiles[r],i=findListElement(t,n);i!=-1&&t.splice(i,1)},this.draw=function(){var n=new Vector(-cameraPos.x%16,-cameraPos.y%16),t,i;for(tileEdgeOffsetList=[n.y,n.x+16,n.y+8,n.x];n.y<screenDim.y-16;)t=new Vector(n.x+cameraPos.x,n.y+cameraPos.y),i=this.getVisibleTile(t),i==-1&&new VisibleTile(t),n.x+=16,n.x>screenDim.x&&(n.x=0,n.y+=16)},this.getEntities=function(n,t){for(var e=[],o=(n.x>>4)-1,s=(n.y>>4)-1,h=(t.x>>4)+1,c=(t.y>>4)+1,i=new Vector(o,s),u,r,f;i.y<=c;){if(!(i.x<0||i.y<0||i.x>=levelDim.x||i.y>=levelDim.y))for(u=this.entitiesInTiles[i.x+i.y*levelDim.x],r=0;r<u.length;)f=u[r],f.intersects(n,t)&&e.push(f),r+=1;i.x+=1,i.x>h&&(i.x=o,i.y+=1)}return e},this.add=function(n){this.entities.push(n),this.addEntityToTile(n)},this.setTileFromId=function(n,t){var i=convertPosIntoLevelIndex(t);this.tileObjectList[i]=createTileFromId(n,t),this.tileIdList[i]=n},i!=undefined)for(r=new Vector(0,0);r.y<levelDim.y*16;)i.getTileId(r)==14&&(this.setTileId(r,15),this.depth==0?(this.setTileId(new Vector(r.x-16,r.y-16),18),this.setTileId(new Vector(r.x,r.y-16),18),this.setTileId(new Vector(r.x+16,r.y-16),18),this.setTileId(new Vector(r.x-16,r.y),18),this.setTileId(new Vector(r.x+16,r.y),18),this.setTileId(new Vector(r.x-16,r.y+16),18),this.setTileId(new Vector(r.x,r.y+16),18),this.setTileId(new Vector(r.x+16,r.y+16),18)):(this.setTileId(new Vector(r.x-16,r.y-16),5),this.setTileId(new Vector(r.x,r.y-16),5),this.setTileId(new Vector(r.x+16,r.y-16),5),this.setTileId(new Vector(r.x-16,r.y),5),this.setTileId(new Vector(r.x+16,r.y),5),this.setTileId(new Vector(r.x-16,r.y+16),5),this.setTileId(new Vector(r.x,r.y+16),5),this.setTileId(new Vector(r.x+16,r.y+16),5))),r.x+=16,r.x>levelDim.x*16&&(r.x=0,r.y+=16);this.depth==-1&&this.add(new AirWizard(new Vector(levelDim.x*8,levelDim.y*8)))}function scheduleChangeLevel(n){changeLevelOffset=n,setGameState(10)}function changeLevel(n){for(var t=visibleTileList.length-1,i;t>-1;)visibleTileList[t].remove(),t-=1;for(removeAllSprites(!0),t=0;t<visibleEntityList.length;)visibleEntityList[t].removed=!0,t+=1;visibleTileList=[],visibleEntityList=[],currentLevel.removeEntityFromTile(currentPlayer),i=findListElement(currentLevel.entities,currentPlayer),currentLevel.entities.splice(i,1),currentLevelDepth+=n,currentLevel=levelList[currentLevelDepth],currentLevel==undefined&&(currentLevel=new Level(createAndValidateUndergroundMap(currentLevelDepth),currentLevelDepth,levelList[currentLevelDepth-1]),levelList[currentLevelDepth]=currentLevel),currentLevel.add(currentPlayer),currentLevel.draw()}function LevelGenOld(n){var f;this.dim=n,this.values=[];for(var u=new Vector(Math.random()*this.dim.x,Math.random()*this.dim.y),r=0,i=new Vector(0,0);r<this.dim.x*this.dim.y;)f=Math.sqrt(Math.pow(u.x-i.x,2)+Math.pow(u.y/2-i.y,2)),this.values[r]=f/5%2-1,r+=1,i.x+=1,i.x>this.dim.x-1&&(i.x=0,i.y+=1)}function LevelGen(n,t){var f,u,i;for(this.dim=n,this.values=[],this.sample=function(n){return this.values[(n.x&this.dim.x-1)+(n.y&this.dim.y-1)*this.dim.x]},this.setSample=function(n,t){this.values[(n.x&this.dim.x-1)+(n.y&this.dim.y-1)*this.dim.x]=t},f=0;f<this.dim.x*this.dim.y;)this.values[f]=Math.random()*2-1,f+=1;var r=t,e=1/this.dim.x,h=1;do{for(u=r/2,i=new Vector(0,0);i.y<this.dim.y;){var o=this.sample(i),c=this.sample(new Vector(i.x+r,i.y)),l=this.sample(new Vector(i.x,i.y+r)),s=this.sample(new Vector(i.x+r,i.y+r)),a=(o+c+l+s)/4+(Math.random()*2-1)*r*e;this.setSample(new Vector(i.x+u,i.y+u),a),i.x+=r,i.x>=this.dim.x&&(i.x=0,i.y+=r)}for(i=new Vector(0,0);i.y<this.dim.y;){var o=this.sample(i),c=this.sample(new Vector(i.x+r,i.y)),l=this.sample(new Vector(i.x,i.y+r)),s=this.sample(new Vector(i.x+u,i.y+u)),a=this.sample(new Vector(i.x+u,i.y-u)),v=this.sample(new Vector(i.x-u,i.y+u)),y=(o+c+s+a)/4+(Math.random()*2-1)*r*e*.5,p=(o+l+s+v)/4+(Math.random()*2-1)*r*e*.5;this.setSample(new Vector(i.x+u,i.y),y),this.setSample(new Vector(i.x,i.y+u),p),i.x+=r,i.x>=this.dim.x&&(i.x=0,i.y+=r)}r/=2,e*=h+.8,h*=.3}while(r>1)}function createSkyMap(){for(var v=new LevelGen(levelDim,8),y=new LevelGen(levelDim,8),u=[],i=new Vector(0,0),n,a,t,r;i.y<levelDim.y;){var t=i.x+i.y*levelDim.x,s=Math.abs(v.values[t]-y.values[t])*3-2,h=i.x/(levelDim.x-1)*2-1,c=i.y/(levelDim.y-1)*2-1;h<0&&(h=-h),c<0&&(c=-c),n=h>=c?h:c,n=n*n*n*n,n=n*n*n*n,s=-s*1-2.2,s=s+1-n*20,u[t]=s<-.25?16:17,i.x+=1,i.x>levelDim.x-1&&(i.x=0,i.y+=1)}for(t=0;t<levelDim.x*levelDim.y/50;){t+=1;for(var f=parseInt(Math.random()*(levelDim.x-2))+1,e=parseInt(Math.random()*(levelDim.x-2))+1,l=0,o=e-1;o<=e+1;){for(r=f-1;r<=f+1;)u[r+o*levelDim.x]==17&&(l+=1),r+=1;o+=1}l==9&&(u[f+e*levelDim.x]=22)}for(a=0,t=0;t<levelDim.x*levelDim.y/100;){t+=1;for(var f=parseInt(Math.random()*(levelDim.x-2))+1,e=parseInt(Math.random()*(levelDim.y-2))+1,l=0,o=e-1;o<=e+1;){for(r=f-1;r<=f+1;)u[r+o*levelDim.x]==17&&(l+=1),r+=1;o+=1}if(l==9&&(u[f+e*levelDim.x]=14,a+=1,a==4))break}return u}function createUndergroundMap(n){for(var d=new LevelGen(levelDim,16),g=new LevelGen(levelDim,16),nt=new LevelGen(levelDim,16),tt=new LevelGen(levelDim,16),it=new LevelGen(levelDim,16),rt=new LevelGen(levelDim,16),ut=new LevelGen(levelDim,16),ft=new LevelGen(levelDim,16),et=new LevelGen(levelDim,16),ot=new LevelGen(levelDim,32),st=new LevelGen(levelDim,32),r=[],u=new Vector(0,0),h,p,o,s,i,c,e,w,t,f;u.y<levelDim.y;){var t=u.x+u.y*levelDim.x,l=Math.abs(ot.values[t]-st.values[t])*3-2,y=Math.abs(d.values[t]-g.values[t]);y=Math.abs(y-nt.values[t])*3-2,h=Math.abs(tt.values[t]-it.values[t]),h=Math.abs(h-rt.values[t])*3-2,p=Math.abs(ut.values[t]-ft.values[t]),p=Math.abs(h-et.values[t])*3-2,o=u.x/(levelDim.x-1)*2-1,s=u.y/(levelDim.y-1)*2-1,o<0&&(o=-o),s<0&&(s=-s),i=o>=s?o:s,i=i*i*i*i,i=i*i*i*i,l=l+1-i*20,r[t]=l>-2&&p<-2+parseInt(n/2)*3?n>2?13:2:l>-2&&(y<-1.7||h<-1.4)?5:1,u.x+=1,u.x>levelDim.x-1&&(u.x=0,u.y+=1)}for(c=2,t=0;t<levelDim.x*levelDim.y/400;){for(var a=parseInt(Math.random()*levelDim.x),v=parseInt(Math.random()*levelDim.y),b=0;b<30;)f=a+parseInt(Math.random()*5)-parseInt(Math.random()*5),e=v+parseInt(Math.random()*5)-parseInt(Math.random()*5),f>=c&&e>=c&&f<levelDim.x-c&&e<levelDim.y-c&&r[f+e*levelDim.x]==1&&(r[f+e*levelDim.x]=18+n),b+=1;t+=1}if(n<3)for(w=0,t=0;t<levelDim.x*levelDim.y/100;){t+=1;for(var a=parseInt(Math.random()*(levelDim.x-2))+1,v=parseInt(Math.random()*(levelDim.y-2))+1,k=0,e=v-1;e<=v+1;){for(f=a-1;f<=a+1;)r[f+e*levelDim.x]==1&&(k+=1),f+=1;e+=1}if(k==9&&(r[a+v*levelDim.x]=14,w+=1,w==4))break}return r}function createTopMap(){for(var k=new LevelGen(levelDim,16),d=new LevelGen(levelDim,16),g=new LevelGen(levelDim,16),nt=new LevelGen(levelDim,32),tt=new LevelGen(levelDim,32),r=[],f=new Vector(0,0),e,o,u,t,v,i,n;f.y<levelDim.y;){var i=f.x+f.y*levelDim.x,l=Math.abs(nt.values[i]-tt.values[i])*3-2,a=Math.abs(k.values[i]-d.values[i]);a=Math.abs(a-g.values[i])*3-2,e=f.x/(levelDim.x-1)*2-1,o=f.y/(levelDim.y-1)*2-1,e<0&&(e=-e),o<0&&(o=-o),u=e>=o?e:o,u=u*u*u*u,u=u*u*u*u,l=l+1-u*20,r[i]=l<-.5?2:l>.5&&a<-1.5?1:0,f.x+=1,f.x>levelDim.x-1&&(f.x=0,f.y+=1)}for(i=0;i<levelDim.x*levelDim.y/2800;){for(var it=parseInt(Math.random()*levelDim.x),rt=parseInt(Math.random()*levelDim.y),y=0;y<10;){for(var h=it+parseInt(Math.random()*21)-10,c=rt+parseInt(Math.random()*21)-10,s=0;s<100;){for(var p=h+parseInt(Math.random()*5)-parseInt(Math.random()*5),w=c+parseInt(Math.random()*5)-parseInt(Math.random()*5),t=w-1;t<=w+1;){for(n=p-1;n<=p+1;)n>=0&&t>=0&&n<levelDim.x&&t<levelDim.y&&r[n+t*levelDim.x]==0&&(r[n+t*levelDim.x]=6),n+=1;t+=1}s+=1}y+=1}i+=1}for(i=0;i<levelDim.x*levelDim.y/400;){for(var h=parseInt(Math.random()*levelDim.x),c=parseInt(Math.random()*levelDim.y),s=0;s<200;)n=h+parseInt(Math.random()*15)-parseInt(Math.random()*15),t=c+parseInt(Math.random()*15)-parseInt(Math.random()*15),n>=0&&t>=0&&n<levelDim.x&&t<levelDim.y&&r[n+t*levelDim.x]==0&&(r[n+t*levelDim.x]=4),s+=1;i+=1}for(i=0;i<levelDim.x*levelDim.y/400;){for(var h=parseInt(Math.random()*levelDim.x),c=parseInt(Math.random()*levelDim.y),s=0;s<30;)n=h+parseInt(Math.random()*5)-parseInt(Math.random()*5),t=c+parseInt(Math.random()*5)-parseInt(Math.random()*5),n>=0&&t>=0&&n<levelDim.x&&t<levelDim.y&&r[n+t*levelDim.x]==0&&(r[n+t*levelDim.x]=3),s+=1;i+=1}for(i=0;i<levelDim.x*levelDim.y/100;)n=parseInt(Math.random()*levelDim.x),t=parseInt(Math.random()*levelDim.y),n>=0&&t>=0&&n<levelDim.x&&t<levelDim.y&&r[n+t*levelDim.x]==6&&(r[n+t*levelDim.x]=7),i+=1;for(v=0,i=0;i<levelDim.x*levelDim.y/1;){i+=1;for(var h=parseInt(Math.random()*(levelDim.x-2))+1,c=parseInt(Math.random()*(levelDim.y-2))+1,b=0,t=c-1;t<=c+1;){for(n=h-1;n<=h+1;)r[n+t*levelDim.x]==1&&(b+=1),n+=1;t+=1}if(b==9&&(r[h+c*levelDim.x]=14,v+=1,v==4))break}return r}function createAndValidateSkyMap(){var n;do{for(var i=createSkyMap(),t=[],n=0;n<tileObjectSet.length;)t[n]=0,n+=1;for(n=0;n<levelDim.x*levelDim.y;)t[i[n]]+=1,n+=1;if(!(t[17]<2e3)&&!(t[14]<2))return i}while(1)}function createAndValidateUndergroundMap(n){var t;do{for(var r=createUndergroundMap(n),i=[],t=0;t<tileObjectSet.length;)i[t]=0,t+=1;for(t=0;t<levelDim.x*levelDim.y;)i[r[t]]+=1,t+=1;if(!(i[1]<100)&&!(i[5]<100)&&!(i[18+n]<20)&&(!(n<3)||!(i[14]<2)))return r}while(1)}function createAndValidateTopMap(){var t;do{for(var i=createTopMap(),n=[],t=0;t<tileObjectSet.length;)n[t]=0,t+=1;for(t=0;t<levelDim.x*levelDim.y;)n[i[t]]+=1,t+=1;if(!(n[1]<100)&&!(n[6]<100)&&!(n[0]<100)&&!(n[4]<100)&&!(n[14]<2))return i}while(1)}function moveSpriteGroup(n,t){for(var r=0,u,i;r<n.length;)u=n[r],i=getSpritePos(u),i.x+=t.x,i.y+=t.y,setSpritePos(u,i),r+=1}function removeOffscreenTiles(){for(var t=visibleTileList.length-1;t>-1;){var r=visibleTileList[t],i=getSpritePos(r.spriteGroup[0]),n=!1;i.x+15<0&&(n=!0),i.x>screenDim.x-1&&(n=!0),i.y+15<0&&(n=!0),i.y>screenDim.y-17&&(n=!0),n&&r.remove(t),t-=1}}function drawLevelTileLine(n,t,i){for(var r=new Vector(n.x+cameraPos.x,n.y+cameraPos.y),u;i>0;)u=currentLevel.getVisibleTile(r),u==-1&&new VisibleTile(r),r.x+=t.x*16,r.y+=t.y*16,i-=1}function moveCamera(n){var u,i,f,r,t;for(cameraPos.x+n.x<0&&(n.x=-cameraPos.x),cameraPos.x+n.x+screenDim.x>levelDim.x*16&&(n.x=levelDim.x*16-cameraPos.x-screenDim.x),cameraPos.y+n.y<0&&(n.y=-cameraPos.y),cameraPos.y+n.y+screenDim.y>levelDim.y*16&&(n.y=levelDim.y*16-cameraPos.y-screenDim.y),cameraPos.x+=n.x,cameraPos.y+=n.y,u=window.frames[0].document.getElementById("body").childNodes,i=u.length-1;i>-1;)f=u[i],r=getSpritePos(f),r.x-=n.x,r.y-=n.y,setSpritePos(f,r),i-=1;tileEdgeOffsetList[0]-=n.y,tileEdgeOffsetList[1]-=n.x,tileEdgeOffsetList[2]-=n.y,tileEdgeOffsetList[3]-=n.x,tileEdgeOffsetList[0]>0&&(t=new Vector(0,0),drawLevelTileLine(t,new Vector(1,0),13),tileEdgeOffsetList[0]-=16),tileEdgeOffsetList[0]<-15&&(tileEdgeOffsetList[0]+=16),tileEdgeOffsetList[1]<0&&(t=new Vector(screenDim.x,0),drawLevelTileLine(t,new Vector(0,1),8),tileEdgeOffsetList[1]+=16),tileEdgeOffsetList[1]>15&&(tileEdgeOffsetList[1]-=16),tileEdgeOffsetList[2]<0&&(t=new Vector(0,screenDim.y-16),drawLevelTileLine(t,new Vector(1,0),13),tileEdgeOffsetList[2]+=16),tileEdgeOffsetList[2]>15&&(tileEdgeOffsetList[2]-=16),tileEdgeOffsetList[3]>0&&(t=new Vector(0,0),drawLevelTileLine(t,new Vector(0,1),8),tileEdgeOffsetList[3]-=16),tileEdgeOffsetList[3]<-15&&(tileEdgeOffsetList[3]+=16),removeOffscreenTiles()}function Entity(n){this.pos=n,this.radii=new Vector(6,6),this.removed=!0,this.isDead=!1,this.spriteGroup=[],this.zIndexPriority=1,this.tick=function(){return!1},this.draw=function(){return!1},this.addToVisibleEntityList=function(){setSpriteGroupZIndex(this.spriteGroup,1),this.updateSprites(),visibleEntityList.push(this),this.removed=!1},this.updateSprites=function(){return!1},this.remove=function(n){if(n==undefined)for(n=0;n<visibleEntityList.length;){if(visibleEntityList[n]==this)break;n+=1}n<visibleEntityList.length&&visibleEntityList.splice(n,1),removeSpriteGroup(this.spriteGroup,!0),this.removed=!0},this.die=function(){this.remove(),currentLevel.removeEntityFromTile(this);var n=currentLevel.entities,t=findListElement(n,this);t!=-1&&n.splice(t,1),this.isDead=!0},this.intersects=function(n,t){return!(this.pos.x+this.radii.x<n.x||this.pos.y+this.radii.y<n.y||this.pos.x-this.radii.x>t.x||this.pos.y-this.radii.y>t.y)},this.blocks=function(){return!1},this.touchedBy=function(){return!1},this.isBlockableBy=function(){return!0},this.touchItem=function(){return!1},this.canSwim=function(){return!1},this.interact=function(n,t){return n!=-1?n.interact(this,t):!1},this.use=function(){return!1},this.getLightRadius=function(){return 0},this.move=function(n){var t;if(n.x!=0||n.y!=0){if(t=!0,n.x!=0&&this.move2(new Vector(n.x,0))&&(t=!1),n.y!=0&&this.move2(new Vector(0,n.y))&&(t=!1),!t){var r=this.pos.x,u=this.pos.y,i=new Vector(r,u);currentLevel.getTileObject(i).steppedOn(i,this)}return!t}return!0},this.move2=function(n){for(var s=this.pos.x-this.radii.x>>4,h=this.pos.y-this.radii.y>>4,c=this.pos.x+this.radii.x>>4,l=this.pos.y+this.radii.y>>4,e=this.pos.x+n.x-this.radii.x>>4,a=this.pos.y+n.y-this.radii.y>>4,v=this.pos.x+n.x+this.radii.x>>4,y=this.pos.y+n.y+this.radii.y>>4,o=!1,t=new Vector(e,a),p=0,f,i,u;t.y<=y;){if(!(t.x>=s&&t.x<=c&&t.y>=h&&t.y<=l)&&(p+=1,f=currentLevel.getTileObject(new Vector(t.x*16,t.y*16)),f.bumpedInto(t,this),!f.mayPass(t,this)))return o=!0,!1;t.x+=1,t.x>v&&(t.x=e,t.y+=1)}if(o)return!1;for(var w=currentLevel.getEntities(new Vector(this.pos.x-this.radii.x,this.pos.y-this.radii.y),new Vector(this.pos.x+this.radii.x,this.pos.y+this.radii.y)),r=currentLevel.getEntities(new Vector(this.pos.x-this.radii.x+n.x,this.pos.y-this.radii.y+n.y),new Vector(this.pos.x+this.radii.x+n.x,this.pos.y+this.radii.y+n.y)),i=0;i<r.length;)(u=r[i],i+=1,u!=this)&&u.touchedBy(this);for(i=r.length-1;i>-1;)findListElement(w,r[i])>-1&&r.splice(i,1),i-=1;for(i=0;i<r.length;)if((u=r[i],i+=1,u!=this)&&u.blocks(this))return!1;return this.moveToPos(new Vector(this.pos.x+n.x,this.pos.y+n.y)),!0},this.moveToPos=function(n){moveSpriteGroup(this.spriteGroup,new Vector(n.x-this.pos.x,n.y-this.pos.y)),currentLevel.removeEntityFromTile(this),this.pos=n,currentLevel.addEntityToTile(this)},this.hurtFromMob=function(){return!1},this.hurtFromTile=function(){return!1}}function TextParticle(n,t,i){this.zIndexPriority=2,this.msg=n,this.pos=t,this.precisePos=t.copy(),this.preciseAltitude=2,this.col=i,this.time=0,this.posOffset=new Vector(Math.random()*4-2,Math.random()*4-2),this.altitudeOffset=18/frameRate+Math.random()*2,this.tick=function(){if(this.time+=1,this.time>50/frameRate)return this.die(),0;this.precisePos.x+=this.posOffset.x,this.precisePos.y+=this.posOffset.y,this.preciseAltitude+=this.altitudeOffset,this.preciseAltitude<0&&(this.preciseAltitude=0,this.altitudeOffset*=-.5,this.posOffset.x*=.6,this.posOffset.y*=.6),this.altitudeOffset-=5/frameRate,this.moveToPos(new Vector(Math.round(this.precisePos.x),Math.round(this.precisePos.y-this.preciseAltitude)))},this.draw=function(){var n=new Vector(this.pos.x-cameraPos.x-4,this.pos.y-cameraPos.y-4),i=new Vector(n.x+1,n.y+1),t;this.spriteGroup=drawFont(this.msg,i,3,!0),t=drawFont(this.msg,n,this.col,!0),concatenateLists(this.spriteGroup,t),this.addToVisibleEntityList()},this.updateSprites=function(){}}function Spark(n,t){this.zIndexPriority=2,this.pos=n,this.offset=t,this.precisePos=n.copy(),this.lifeTime=parseInt((600+Math.random()*30)/frameRate),this.tick=function(){var i,t,n;if(this.precisePos.x+=this.offset.x,this.precisePos.y+=this.offset.y,this.moveToPos(new Vector(Math.round(this.precisePos.x),Math.round(this.precisePos.y))),this.lifeTime-=1,this.lifeTime<1)return this.die(),0;for(i=currentLevel.getEntities(this.pos,this.pos),t=0;t<i.length;)n=i[t],n.health!=undefined&&n!=currentAirWizard&&n.hurtFromMob(currentAirWizard,1,n.dir^1),t+=1;this.removed||this.updateSprites()},this.draw=function(){this.spriteGroup=[];var n=new Vector(this.pos.x-cameraPos.x-4,this.pos.y-cameraPos.y-4);this.spriteGroup.push(addSprite(new Vector(1,1),n,0,0,!0)),this.addToVisibleEntityList()},this.updateSprites=function(){setSpriteType(this.spriteGroup[0],12+parseInt(Math.random()*2)+(12+parseInt(Math.random()*2))*32)}}function SmashParticle(n){this.zIndexPriority=2,this.pos=n,this.time=0,this.tick=function(){return this.time+=1,this.time>8/frameRate?(this.die(),0):void 0},this.draw=function(){this.spriteGroup=[];var n=new Vector(this.pos.x-cameraPos.x-8,this.pos.y-cameraPos.y-8);this.spriteGroup.push(addSprite(new Vector(2,2),n,0,[0,0,0,1],!0)),this.addToVisibleEntityList()},this.updateSprites=function(){var n=this.spriteGroup[0];setSpriteType(n,394)}}function ItemEntity(n,t){this.item=n,this.pos=t,this.precisePos=t.copy(),this.preciseAltitude=2,this.time=0,this.lifeTime=480/frameRate+Math.random()*30,this.posOffset=new Vector(Math.random()*4-2,Math.random()*4-2),this.altitudeOffset=18/frameRate+Math.random()*2,this.tick=function(){if(this.time+=1,this.lifeTime-=1,this.lifeTime<0)return this.die(),0;this.precisePos.x+=this.posOffset.x,this.precisePos.y+=this.posOffset.y,this.preciseAltitude+=this.altitudeOffset,this.preciseAltitude<0&&(this.preciseAltitude=0,this.altitudeOffset*=-.5,this.posOffset.x*=.6,this.posOffset.y*=.6),this.altitudeOffset-=5/frameRate;var n=new Vector(Math.round(this.precisePos.x),Math.round(this.precisePos.y-this.preciseAltitude));this.move(new Vector(n.x-this.pos.x,n.y-this.pos.y))||(this.precisePos=this.pos.copy()),this.updateSprites()},this.isBlockableBy=function(){return!1},this.touchedBy=function(n){if(this.isDead)return!1;if(n==currentPlayer&&this.time>30/frameRate){n.inventory.add(this.item),n.score+=1;this.item.onTake(this);return playSound(4),this.die(),0}},this.draw=function(){this.spriteGroup=[];var n=new Vector(this.pos.x-cameraPos.x-4,this.pos.y-cameraPos.y-4);this.spriteGroup.push(this.item.draw(n,!0)),this.addToVisibleEntityList()},this.updateSprites=function(){var n;n=this.lifeTime<80/frameRate&&this.lifeTime%6<3?-1:this.item.getColorNumberLust(),this.spriteGroup.length>0&&setSpriteColorNumberLust(this.spriteGroup[0],n)}}function Item(){this.getColorNumberLust=function(){return 0},this.getSpriteType=function(){return 0},this.onTake=function(){},this.drawInventory=function(){},this.draw=function(){},this.updateSprite=function(){},this.interact=function(){return!1},this.interactOn=function(){return!1},this.isDepleted=function(){return!1},this.canAttack=function(){return!1},this.getAttackDamageBonus=function(){return 0},this.getName=function(){return""},this.matches=function(n){return n.getName()==this.getName()}}function PowerGloveItem(){this.getColorNumberLust=function(){return 0},this.getSpriteType=function(){return 135},this.draw=function(n,t){return addSprite(new Vector(1,1),n,this.getSpriteType(),this.getColorNumberLust(),t)},this.updateSprite=function(n){setSpriteColorNumberLust(n,0),setSpriteType(n,this.getSpriteType())},this.drawInventory=function(n,t){var i=[],r;return i.push(this.draw(n,t)),r=drawFont(this.getName(),new Vector(n.x+8,n.y),[0,0,0,555],t),concatenateLists(i,r),i},this.getName=function(){return"Pow glove"},this.interact=function(n){return n.pushTime!=undefined?(n.take(currentPlayer),!0):!1}}function ResourceItem(n,t){this.resource=n,this.count=t==undefined?1:t,this.getColorNumberLust=function(){return this.resource.colorNumberLust},this.getSpriteType=function(){return this.resource.spriteType},this.drawInventory=function(n,t){var i=[],r,u;return i.push(this.draw(n,t)),u=drawFont(this.resource.name,new Vector(n.x+32,n.y),0,t),concatenateLists(i,u),r=this.count,r>999&&(r=999),u=drawFont(""+r,new Vector(n.x+8,n.y),1,t),concatenateLists(i,u),i},this.draw=function(n,t){return addSprite(new Vector(1,1),n,this.resource.spriteType,this.resource.colorNumberLust,t)},this.updateSprite=function(n){setSpriteColorNumberLust(n,this.resource.colorNumberLust),setSpriteType(n,this.resource.spriteType)},this.getName=function(){return this.resource.name},this.interactOn=function(n,t,i){return this.resource.interactOn(n,t,i)?(this.count-=1,!0):!1},this.isDepleted=function(){return this.count<=0}}function Resource(n,t,i){this.name=n,this.spriteType=t,this.colorNumberLust=i,this.interactOn=function(){return!1}}function PlantableResource(n,t,i,r,u){this.name=n,this.spriteType=t,this.colorNumberLust=i,this.targetTileId=r,this.sourceTileIdList=u,this.interactOn=function(n,t){return findListElement(this.sourceTileIdList,n.id)!=-1?(n.swap(t,this.targetTileId),!0):!1}}function FoodResource(n,t,i,r,u){this.name=n,this.spriteType=t,this.colorNumberLust=i,this.heal=r,this.staminaCost=u,this.interactOn=function(){var r=currentPlayer.maxHealth;return currentPlayer.health>r-1?!1:currentPlayer.payStamina(this.staminaCost)?(currentPlayer.health+=this.heal,currentPlayer.health>r&&(currentPlayer.health=r),currentLevel.add(new TextParticle(""+this.heal,currentPlayer.pos.copy(),7)),!0):!0}}function FurnitureItem(n){this.placed=!1,this.furniture=n,this.getColorNumberLust=function(){return 0},this.getSpriteType=function(){return this.furniture.spriteType+320},this.draw=function(n,t){return addSprite(new Vector(1,1),n,this.getSpriteType(),this.getColorNumberLust(),t)},this.updateSprite=function(n){setSpriteColorNumberLust(n,this.getColorNumberLust()),setSpriteType(n,this.getSpriteType())},this.drawInventory=function(n,t){var i=[],r;return i.push(this.draw(n,t)),r=drawFont(this.furniture.name,new Vector(n.x+8,n.y),[0,0,0,555],t),concatenateLists(i,r),i},this.onTake=function(){},this.canAttack=function(){return!1},this.interactOn=function(n,t){return n.mayPass(t,this.furniture)?(this.furniture.pos=new Vector(parseInt(t.x/16)*16+8,parseInt(t.y/16)*16+8),this.furniture.isDead=!1,this.furniture.isRemoved=!1,currentLevel.add(this.furniture),this.placed=!0,!0):!1},this.isDepleted=function(){return this.placed},this.getName=function(){return this.furniture.name}}function Furniture(n){this.pushTime=0,this.pushDir=-1,this.col=[0,0,0,0],this.spriteType=0,this.name=n,this.shouldTake=-1,this.radii=new Vector(3,3),this.tick=function(){if(this.shouldTake!=-1){this.die();var n=new FurnitureItem(this);return this.shouldTake.inventory.addToSlot(0,n),this.shouldTake.equip(n),this.shouldTake=-1,0}this.pushDir==0&&this.move(new Vector(0,1)),this.pushDir==1&&this.move(new Vector(0,-1)),this.pushDir==2&&this.move(new Vector(-1,0)),this.pushDir==3&&this.move(new Vector(1,0)),this.pushDir=-1,this.pushTime>0&&(this.pushTime-=1)},this.draw=function(){this.spriteGroup=[];var n=new Vector(this.pos.x-cameraPos.x-8,this.pos.y-cameraPos.y-12);this.spriteGroup.push(addSprite(new Vector(2,2),n,this.spriteType*2+256,this.col,!0)),this.addToVisibleEntityList()},this.blocks=function(){return!0},this.touchedBy=function(n){n==currentPlayer&&this.pushTime==0&&(this.pushDir=n.dir,this.pushTime=9/frameRate)},this.take=function(n){this.shouldTake=n}}function Workbench(){this.name="Workbench",this.col=0,this.spriteType=4,this.radii=new Vector(3,2),this.use=function(){return setGameState(5),!0}}function Furnace(){this.name="Furnace",this.col=0,this.spriteType=3,this.radii=new Vector(3,2),this.use=function(){return setGameState(6),!0}}function Oven(){this.name="Oven",this.col=0,this.spriteType=2,this.radii=new Vector(3,2),this.use=function(){return setGameState(7),!0}}function Anvil(){this.name="Anvil",this.col=0,this.spriteType=0,this.radii=new Vector(3,2),this.use=function(){return setGameState(8),!0}}function Chest(){this.name="Chest",this.col=0,this.spriteType=1,this.inventory=new Inventory,this.radii=new Vector(3,2),this.use=function(){return currentMenuFrameObjectList=this.inventory.items,setGameState(9),!0}}function Lantern(){this.name="Lantern",this.col=0,this.spriteType=5,this.radii=new Vector(3,2),this.getLightRadius=function(){return 8}}function ToolItem(n,t){this.type=n,this.level=t,this.getColorNumberLust=function(){return toolLevelColorNumberLustSet[this.level]},this.getSpriteType=function(){return this.type.spriteType+160},this.draw=function(n,t){return addSprite(new Vector(1,1),n,this.getSpriteType(),this.getColorNumberLust(),t)},this.updateSprite=function(n){setSpriteColorNumberLust(n,this.getColorNumberLust()),setSpriteType(n,this.getSpriteType())},this.drawInventory=function(n,t){var i=[],r;return i.push(this.draw(n,t)),r=drawFont(this.getName(),new Vector(n.x+8,n.y),[0,0,0,555],t),concatenateLists(i,r),i},this.getName=function(){return toolLevelNameSet[this.level]+" "+this.type.name},this.onTake=function(){},this.canAttack=function(){return!0},this.getAttackDamageBonus=function(){return this.type==toolTypeSet[4]?(this.level+1)*2+parseInt(Math.random()*4):this.type==toolTypeSet[2]?(t+1)*3+parseInt(Math.random()*(2+t*t*2)):1},this.matches=function(n){return n.getAttackDamageBonus!=undefined&&n.type!=undefined?n.type.name==this.type.name&&n.level==this.level:!1}}function ToolType(n,t){this.name=n,this.spriteType=t}function Recipe(n){this.costs=[],this.canCraft=!1,this.resultTemplate=n,this.addCost=function(n,t){return this.costs.push(new ResourceItem(n,t)),this},this.checkCanCraft=function(){for(var t=0,n;t<this.costs.length;){if(n=this.costs[t],n.resource!=undefined&&!currentPlayer.inventory.hasResources(n.resource,n.count))return this.canCraft=!1,0;t+=1}this.canCraft=!0},this.drawInventory=function(n,t){var i=[],r,u;return i.push(addSprite(new Vector(1,1),n,this.resultTemplate.getSpriteType(),this.resultTemplate.getColorNumberLust(),t)),r=this.canCraft?0:2,u=drawFont(this.resultTemplate.getName(),new Vector(n.x+8,n.y),r,t),concatenateLists(i,u),i},this.craft=function(){},this.deductCost=function(){for(var n=0,t;n<this.costs.length;)t=this.costs[n],currentPlayer.inventory.removeResource(t.resource,t.count),n+=1}}function updateRecipeSetCanCraftValues(n){for(var t=0,i;t<n.length;)i=n[t],i.checkCanCraft(),t+=1}function ToolRecipe(n,t){this.costs=[],this.type=n,this.level=t,this.resultTemplate=new ToolItem(n,t),this.craft=function(){currentPlayer.inventory.addToSlot(0,new ToolItem(this.type,this.level))}}function FurnitureRecipe(n){this.costs=[],this.clazz=n,this.resultTemplate=new FurnitureItem(new n),this.craft=function(){currentPlayer.inventory.addToSlot(0,new FurnitureItem(new n))}}function ResourceRecipe(n){this.resource=n,this.costs=[],this.resultTemplate=new ResourceItem(this.resource,1),this.craft=function(){currentPlayer.inventory.add(new ResourceItem(this.resource,1))}}function Inventory(){this.items=[],this.add=function(n){this.addToSlot(this.items.length,n)},this.addToSlot=function(n,t){var i,r,f,u;if(t.resource!=undefined)i=t,r=this.findResource(i.resource),r==-1?this.items[n]=i:r.count+=i.count;else for(f=this.items.length,u=this.items[n],this.items[n]=t;n<f;)n+=1,tempItem=u,u=this.items[n],this.items[n]=tempItem},this.findResource=function(n){for(var i=0,t;i<this.items.length;){if(t=this.items[i],t.resource!=undefined&&t.resource==n)return t;i+=1}return-1},this.hasResources=function(n,t){var i=this.findResource(n);return i==-1?!1:i.count>=t},this.removeResource=function(n,t){var i=this.findResource(n),r;return i==-1?!1:i.count<t?!1:(i.count-=t,r=findListElement(this.items,i),i.count<=0&&this.items.splice(r,1),!0)},this.count=function(n){var i,r,t;if(n.resource!=undefined){if(i=this.findResource(n.resource),i!=-1)return i.count}else{for(r=0,t=0;t<this.items.length;)this.items[t].matches(n)&&(r+=1),t+=1;return r}return 0}}function Mob(n){this.pos=n,this.radii=new Vector(4,3),this.walkDist=0,this.dir=0,this.hurtTime=0,this.knockback=new Vector(0,0),this.maxHealth=10,this.health=this.maxHealth,this.swimTimer=0,this.tickTime=0,this.dropItems=function(){},this.hasKnockback=function(){return!(this.knockback.x==0&&this.knockback.y==0)},this.hurtFromMob=function(n,t,i){return this.doHurt(t,i),!0},this.hurtFromTile=function(n,t,i){var r=1;this.dir==1&&(r=0),this.dir==2&&(r=3),this.dir==3&&(r=2),this.doHurt(i,r)},this.doHurt=function(n,t){if(!(this.hurtTime>0)){var i=currentPlayer.pos.x-this.pos.x,r=currentPlayer.pos.y-this.pos.y;i*i+r*r<6400&&playSound(3),currentLevel.add(new TextParticle(""+n,this.pos.copy(),4)),this.health-=n,t==0&&(this.knockback=new Vector(0,4)),t==1&&(this.knockback=new Vector(0,-4)),t==2&&(this.knockback=new Vector(-4,0)),t==3&&(this.knockback=new Vector(4,0)),this.hurtTime=15/frameRate}},this.tick=function(){var i,n,t;if(this.health<=0)return this.dropItems(),this.die(),i=!1,this==currentPlayer&&(playSound(2),setGameStateDelay=60/frameRate,nextGameState=11,i=!0),this==currentAirWizard&&(currentPlayer.score+=1e3,playSound(0),setGameStateDelay=60/frameRate,nextGameState=12,i=!0),i||(currentPlayer.score+=this.jumpTime!=undefined?this.level*25:this.level*50),0;this.hurtTime>0&&(this.hurtTime-=1),this.hasKnockback()&&(n=new Vector(0,0),t=this.knockback.copy(),this.knockback.x<0&&(n=new Vector(-3,0),t.x+=1),this.knockback.x>0&&(n=new Vector(3,0),t.x-=1),this.knockback.y<0&&(n=new Vector(0,-3),t.y+=1),this.knockback.y>0&&(n=new Vector(0,3),t.y-=1),this!=currentAirWizard&&this.moveIfPossible(n),this.knockback=t),this.tickTime+=1,!this.hasKnockback()|this==currentAirWizard&&this.customTick(),this.removed||this.dead||this.updateSprites()},this.customTick=function(){},this.moveIfPossible=function(n){var t,r,i,u;return this.isDead?!1:n.x==0&&n.y==0?!0:(this.isSwimming()&&(n.x=Math.round(n.x*.6),n.y=Math.round(n.y*.6)),this.hasKnockback()||(t=this.dir,(n.x!=0||n.y!=0)&&(n.x<0&&(this.dir=2),n.x>0&&(this.dir=3),n.y<0&&(this.dir=1),n.y>0&&(this.dir=0)),t==this.dir|t<2&&(this.walkDist+=1)),r=this.move(n),this==currentPlayer&&(i=getTargetCameraPos(),u=new Vector(i.x-cameraPos.x,i.y-cameraPos.y),moveCamera(u)),r)},this.findStartPos=function(){var f=parseInt(Math.random()*levelDim.x)*16+8,e=parseInt(Math.random()*levelDim.y)*16+8,n=new Vector(f,e),i=currentPlayer.pos.x-n.x,r=currentPlayer.pos.y-n.y,t,u;return i*i+r*r<6400?!1:(t=128,currentLevelDepth!=0&&(t=64),currentLevel.getEntities(new Vector(n.x-t,n.y-t),new Vector(n.x+t,n.y+t)).length>0)?!1:(u=currentLevel.getTileObject(n),u.mayPass(n,this))?(this.pos=n,!0):!1},this.isSwimming=function(){var n=currentLevel.getTileObject(this.pos);return n.id==2||n.id==13},this.blocks=function(){return!0}}function getTargetCameraPos(){return new Vector(currentPlayer.pos.x-screenDim.x/2,currentPlayer.pos.y-(screenDim.y-16)/2)}function Slime(n,t){this.pos=n,this.offset=new Vector(0,0),this.jumpTime=0,this.level=t,this.maxHealth=this.level*this.level*5,this.health=this.maxHealth,this.dropItems=function(){var n=new Vector(this.pos.x+8,this.pos.y+8);dropResource(n,16,1,2)},this.touchedBy=function(n){n==currentPlayer&&n.hurtFromMob(this,this.level,this.dir)},this.customTick=function(){var n=parseInt(12/frameRate),t,i;(!this.moveIfPossible(this.offset)||Math.random()*20/frameRate<1)&&this.jumpTime<=-10&&(this.offset.x=(parseInt(Math.random()*3)-1)*n,this.offset.y=(parseInt(Math.random()*3)-1)*n,t=currentPlayer.pos.x-this.pos.x,i=currentPlayer.pos.y-this.pos.y,t*t+i*i<2500&&(t<0&&(this.offset.x=-n),t>0&&(this.offset.x=n),i<0&&(this.offset.y=-n),i>0&&(this.offset.y=n)),(this.offset.x!=0||this.offset.y!=0)&&(this.jumpTime=parseInt(12/frameRate))),this.jumpTime-=1,this.jumpTime==0&&(this.offset=new Vector(0,0))},this.draw=function(){this.spriteGroup=[];var n=new Vector(this.pos.x-cameraPos.x-8,this.pos.y-cameraPos.y-11);this.spriteGroup.push(addSprite(new Vector(2,2),n,0,[1,1,1,1],!0)),this.addToVisibleEntityList()},this.updateSprites=function(){var n,u;n=this.hasKnockback()?1:this.level==1?0:this.level;var t=this.spriteGroup[0],i=0,r=0;this.jumpTime>0&&(i=2,r=-4),u=new Vector(this.pos.x-cameraPos.x-8,this.pos.y-cameraPos.y-11+r),setSpritePos(t,u),setSpriteColorNumberLust(t,n),setSpriteType(t,i+576)}}function Zombie(n,t){this.pos=n,this.offset=new Vector(0,0),this.randomWalkTime=0,this.level=t,this.maxHealth=this.level*this.level*10,this.health=this.maxHealth,this.dropItems=function(){var n=new Vector(this.pos.x+8,this.pos.y+8);dropResource(n,18,1,2)},this.touchedBy=function(n){n==currentPlayer&&n.hurtFromMob(this,this.level+1,this.dir)},this.customTick=function(){var i=parseInt(8/frameRate),n,t;this.randomWalkTime<1&&(n=currentPlayer.pos.x-this.pos.x,t=currentPlayer.pos.y-this.pos.y,n*n+t*t<2500&&(this.offset=new Vector(0,0),n<0&&(this.offset.x=-i),n>0&&(this.offset.x=i),t<0&&(this.offset.y=-i),t>0&&(this.offset.y=i))),(!this.moveIfPossible(this.offset)||Math.random()*80/frameRate<1)&&(this.randomWalkTime=23/frameRate,this.offset.x=(parseInt(Math.random()*3)-1)*parseInt(Math.random()*2)*2,this.offset.y=(parseInt(Math.random()*3)-1)*parseInt(Math.random()*2)*2),this.randomWalkTime>0&&(this.randomWalkTime-=1)},this.draw=function(){this.spriteGroup=[];var n=new Vector(this.pos.x-cameraPos.x-8,this.pos.y-cameraPos.y-11);this.spriteGroup.push(addSprite(new Vector(2,2),n,0,[1,1,1,1],!0)),this.addToVisibleEntityList()},this.updateSprites=function(){var i,n,t;i=this.hasKnockback()?1:this.level+1,n=0,this.walkDist%(frameRate*1.6)<frameRate*.8&&(n=1),t=this.spriteGroup[0],setSpriteColorNumberLust(t,i),this.dir==0&&setSpriteType(t,0+(14+n*6)*32),this.dir==1&&setSpriteType(t,2+(14+n*6)*32),this.dir==2&&setSpriteType(t,4+n*2+640),this.dir==3&&setSpriteType(t,4+n*2+448)}}function AirWizard(n){currentAirWizard=this,this.pos=n,this.offset=new Vector(0,0),this.randomWalkTime=0,this.attackDelay=0,this.attackTime=0,this.attackType=0,this.maxHealth=2e3,this.health=this.maxHealth,this.touchedBy=function(n){n==currentPlayer&&n.hurtFromMob(this,3,this.dir)},this.customTick=function(){var i,r,u,n,t;if(this.moveIfPossible(this.offset),i=parseInt(10/frameRate),this.attackDelay>0)return this.dir=parseInt(this.attackDelay)%4,this.dir=this.dir*2%4+parseInt(this.dir/2),this.attackDelay<39/frameRate&&(this.dir=0),this.attackDelay-=1,this.attackDelay==0&&(this.attackType=0,this.health<1e3&&(this.attackType=1),this.health<200&&(this.attackType=2),this.attackTime=120/frameRate),!0;if(this.attackTime>0)return this.attackTime-=1,r=this.attackTime*.6*(this.attackTime%2*2-1),u=(.7+this.attackType*.2)*frameRate,currentLevel.add(new Spark(this.pos,new Vector(Math.cos(r)*u,Math.sin(r)*u))),currentLevel.add(new Spark(this.pos,new Vector(Math.cos(r+.5)*u,Math.sin(r+.5)*u))),!0;n=currentPlayer.pos.x-this.pos.x,t=currentPlayer.pos.y-this.pos.y,this.randomWalkTime==0&&(n*n+t*t<1024?(this.offset.x=0,this.offset.y=0,n<0&&(this.offset.x=i),n>0&&(this.offset.x=-i),t<0&&(this.offset.y=i),t>0&&(this.offset.y=-i)):n*n+t*t>6400&&(this.offset.x=0,this.offset.y=0,n<0&&(this.offset.x=-i),n>0&&(this.offset.x=i),t<0&&(this.offset.y=-i),t>0&&(this.offset.y=i))),Math.random()<.03&&n*n+t*t<14400&&(this.randomWalkTime=parseInt(40/frameRate),this.offset.x=(parseInt(Math.random()*3)-1)*i,this.offset.y=(parseInt(Math.random()*3)-1)*i),this.randomWalkTime>0&&(this.randomWalkTime-=1,this.randomWalkTime==0&&Math.random()<.33&&n*n+t*t<2500&&this.attackDelay==0&&this.attackTime==0&&(this.offset=new Vector(0,0),this.attackDelay=parseInt(120/frameRate)))},this.draw=function(){this.spriteGroup=[];var n=new Vector(this.pos.x-cameraPos.x-8,this.pos.y-cameraPos.y-11);this.spriteGroup.push(addSprite(new Vector(2,2),n,0,[1,1,1,1],!0)),this.addToVisibleEntityList()},this.updateSprites=function(){var i,n,t;i=this.hasKnockback()?1:this.health<this.maxHealth/2&&this.tickTime%6==0?2:0,n=0,this.walkDist%(frameRate*1.6)<frameRate*.8&&(n=1),t=this.spriteGroup[0],setSpriteColorNumberLust(t,i),this.dir==0&&setSpriteType(t,8+(14+n*2)*32),this.dir==1&&setSpriteType(t,10+(14+n*2)*32),this.dir==2&&setSpriteType(t,12+n*2+512),this.dir==3&&setSpriteType(t,12+n*2+448)}}function Player(n){currentPlayer=this,this.score=0,this.maxStamina=10,this.stamina=this.maxStamina,this.staminaRecharge=0,this.staminaRechargeDelay=0,this.onStairDelay=0,this.attackTime=0,this.attackDir=0,this.pos=n,this.inventory=new Inventory,this.inventory.items=[new FurnitureItem(new Workbench),new PowerGloveItem],this.activeItem=-1,this.attackItem=-1,this.touchedBy=function(n){n==currentPlayer||n.touchedBy(this)},this.canSwim=function(){return!0},this.getLightRadius=function(){var n=2,t;return this.activeItem!=-1&&this.activeItem.furniture!=undefined&&(t=this.activeItem.furniture.getLightRadius(),t>n&&(n=t)),n},this.payStamina=function(n){return n>this.stamina?!1:(this.stamina-=n,this.staminaRecharge=0,!0)},this.equip=function(n,t){n==undefined&&(n=-1),this.activeItem=n,this.redrawEquippedItemInfo(),n!=-1&&(t==undefined&&(t=findListElement(this.inventory.items,n)),this.inventory.items.splice(t,1),addElementToStartOfList(this.inventory.items,n))},this.redrawEquippedItemInfo=function(){removeSpriteGroup(currentEquippedItemInfo),this.activeItem!=-1&&(currentEquippedItemInfo=this.activeItem.drawInventory(new Vector(80,screenDim.y-16)))},this.doHurt=function(n,t){if(!(this.hurtTime>0)){var i=currentPlayer.pos.x-this.pos.x,r=currentPlayer.pos.y-this.pos.y;i*i+r*r<6400&&playSound(5),currentLevel.add(new TextParticle(""+n,this.pos.copy(),8)),this.health-=n,t==0&&(this.knockback=new Vector(0,3)),t==1&&(this.knockback=new Vector(0,-3)),t==2&&(this.knockback=new Vector(-3,0)),t==3&&(this.knockback=new Vector(3,0)),this.hurtTime=7}},this.customTick=function(){var t=currentLevel.getTileObject(this.pos),n;if(t.id==14||t.id==15){if(this.onStairDelay==0)return this.onStairDelay=18/frameRate,scheduleChangeLevel(t.id==14?1:-1),0;this.onStairDelay=10}else this.onStairDelay>0&&(this.onStairDelay-=1);this.tickTime%parseInt(50/frameRate)==0&&t.id==13&&(n=0,this.dir==0&&(n=1),this.dir==2&&(n=3),this.dir==3&&(n=2),this.doHurt(4,n)),this.isSwimming()?(this.staminaRechargeDelay-=1,this.staminaRecharge-=1,this.staminaRecharge<-36/frameRate&&(this.payStamina(1)||(n=0,this.dir==0&&(n=1),this.dir==2&&(n=3),this.dir==3&&(n=2),this.doHurt(1,n)),this.staminaRecharge=0)):this.staminaRechargeDelay<1?(this.stamina<1&&(this.staminaRechargeDelay=30/frameRate),this.staminaRecharge<0&&(this.staminaRecharge=0),this.staminaRecharge+=1,this.staminaRecharge>6/frameRate&&(this.staminaRecharge=0,this.stamina<this.maxStamina&&(this.stamina+=1))):(this.staminaRechargeDelay-=1,this.staminaRechargeDelay<1&&(this.staminaRecharge=0,this.stamina+=1)),this.attackTime-=1,this.hasKnockback()||(keyIsHeld[37]&&this.moveIfPossible(new Vector(parseInt(-12/frameRate),0)),keyIsHeld[39]&&this.moveIfPossible(new Vector(parseInt(12/frameRate),0)),keyIsHeld[38]&&this.moveIfPossible(new Vector(0,parseInt(-12/frameRate))),keyIsHeld[40]&&this.moveIfPossible(new Vector(0,parseInt(12/frameRate))))},this.draw=function(){this.spriteGroup=[];var n=new Vector(this.pos.x-cameraPos.x-8,this.pos.y-cameraPos.y-11),t=new Vector(n.x,n.y+7);this.spriteGroup.push(addSprite(new Vector(2,1),t,0,[1,1,1,1],!0)),this.spriteGroup.push(addSprite(new Vector(2,2),n,0,[1,1,1,1],!0)),this.spriteGroup.push(addSprite(new Vector(1,1),n,0,[1,1,1,1],!0)),this.spriteGroup.push(addSprite(new Vector(1,1),n,0,[1,1,1,1],!0)),this.addToVisibleEntityList()};var t;this.updateSprites=function(){var e,t,n,h,l,s,r,u,f;f=this.hasKnockback()?1:0,e=0,this.walkDist%(frameRate*1.6)<frameRate*.8&&(e=1),t=this.spriteGroup[1],r=getSpriteDim(t),waterColor=[0,0,0,0],this.isSwimming()?(waterColor=this.tickTime%(frameRate*1.4)<frameRate*.7?0:1,setSpriteType(this.spriteGroup[0],420),setSpriteColorNumberLust(this.spriteGroup[0],waterColor),r.y>1&&(n=getSpritePos(t),setSpriteDim(t,new Vector(2,1)),n.y+=4,setSpritePos(t,n))):(r.y<2&&(n=getSpritePos(t),setSpriteDim(t,new Vector(2,2)),n.y-=4,setSpritePos(t,n)),setSpriteColorNumberLust(this.spriteGroup[0],-1)),setSpriteColorNumberLust(t,f);var i=this.spriteGroup[3],n=new Vector(this.pos.x-cameraPos.x,this.pos.y-cameraPos.y),o=0,c=!1;this.activeItem!=-1&&(h=this.activeItem.furniture,h!=undefined&&(o=2,setSpriteType(i,h.spriteType*2+256),setSpriteColorNumberLust(i,0),setSpriteDim(i,new Vector(2,2)),this.isSwimming()?setSpritePos(i,new Vector(n.x-8,n.y-19)):setSpritePos(i,new Vector(n.x-8,n.y-23)),c=!0)),this.dir==0&&setSpriteType(t,0+(14+e*6+o)*32),this.dir==1&&setSpriteType(t,2+(14+e*6+o)*32),this.dir==2&&setSpriteType(t,4+e*2+(20+o)*32),this.dir==3&&setSpriteType(t,4+e*2+(14+o)*32),u=this.spriteGroup[2],this.attackTime>0?(f=0,this.attackItem!=-1&&(this.attackItem.updateSprite(i),setSpriteDim(i,new Vector(1,1)))):(f=-1,c||setSpriteColorNumberLust(i,f)),setSpriteColorNumberLust(u,f),this.attackTime>0&&(this.attackDir==0&&(setSpritePos(u,new Vector(n.x-8,n.y+1)),setSpritePos(i,new Vector(n.x-4,n.y+1)),s=422,r=new Vector(2,1)),this.attackDir==1&&(setSpritePos(u,new Vector(n.x-8,n.y-15)),setSpritePos(i,new Vector(n.x-4,n.y-17)),s=390,r=new Vector(2,1)),this.attackDir==2&&(setSpritePos(u,new Vector(n.x-12,n.y-11)),setSpritePos(i,new Vector(n.x-12,n.y-7)),s=392,r=new Vector(1,2)),this.attackDir==3&&(setSpritePos(u,new Vector(n.x+4,n.y-11)),setSpritePos(i,new Vector(n.x+4,n.y-7)),s=393,r=new Vector(1,2)),setSpriteType(u,s),setSpriteDim(u,r))},this.findStartPos=function(){var i=parseInt(Math.random()*levelDim.x)*16+8,r=parseInt(Math.random()*levelDim.y)*16+8,n=new Vector(i,r),t=currentLevel.getTileObject(n);if(this==currentPlayer){if(t.id==0|t.id==5|t.id==17)return this.pos=n,!0}else if(t.mayPass(n,this))return this.pos=n,!0;return!1},this.getAttackDamage=function(n){var t=parseInt(Math.random()*3)+1;return this.attackItem!=-1&&(t+=this.attackItem.getAttackDamageBonus(n)),t},this.attack=function(){var n,i,t,f,r,s;if(!this.payStamina(1))return!1;this.attackItem=this.activeItem,this.attackDir=this.dir,this.walkDist+=frameRate*.8,this.attackTime=3,n=-2,i=20,this.dir==0&&this.hurt(new Vector(this.pos.x-8,this.pos.y+4+n),new Vector(this.pos.x+8,this.pos.y+i+n)),this.dir==1&&this.hurt(new Vector(this.pos.x-8,this.pos.y-i+n),new Vector(this.pos.x+8,this.pos.y-4+n)),this.dir==3&&this.hurt(new Vector(this.pos.x+4,this.pos.y-8+n),new Vector(this.pos.x+i,this.pos.y+8+n)),this.dir==2&&this.hurt(new Vector(this.pos.x-i,this.pos.y-8+n),new Vector(this.pos.x-4,this.pos.y+8+n));var e=this.pos.x,o=this.pos.y+n,u=12;this.attackDir==0&&(o=this.pos.y+u+n),this.attackDir==1&&(o=this.pos.y-u+n),this.attackDir==2&&(e=this.pos.x-u),this.attackDir==3&&(e=this.pos.x+u),t=new Vector(e,o),posIsInLevel(t)&&(f=currentLevel.getTileObject(t),r=!1,this.activeItem!=-1&&this.activeItem.interactOn(f,t,this.attackDir)&&(r=!0,this.activeItem.isDepleted()?(this.equip(-1),this.inventory.items.splice(0,1)):this.redrawEquippedItemInfo()),s=new Vector(parseInt(t.x/16)*16,parseInt(t.y/16)*16),r||this.activeItem!=-1&&f.interact(s,this.activeItem,this.attackDir)&&(r=!0),r||f.hurt(s,parseInt(Math.random()*3)+1,this.attackDir))},this.hurt=function(n,t){for(var f=currentLevel.getEntities(n,t),r=0,i,u;r<f.length;)i=f[r],i!=this&&(u=!1,this.activeItem!=-1&&this.activeItem.interact(i,this.attackDir)&&(u=!0),u||this.stamina>0&&i.hurtFromMob(this,this.getAttackDamage(),this.attackDir)),r+=1},this.useInCurrentDir=function(){var n=-2;return this.dir==0?this.use(new Vector(this.pos.x-8,this.pos.y+4+n),new Vector(this.pos.x+8,this.pos.y+12+n)):this.dir==1?this.use(new Vector(this.pos.x-8,this.pos.y-12+n),new Vector(this.pos.x+8,this.pos.y-4+n)):this.dir==3?this.use(new Vector(this.pos.x+4,this.pos.y-8+n),new Vector(this.pos.x+12,this.pos.y+8+n)):this.dir==2?this.use(new Vector(this.pos.x-12,this.pos.y-8+n),new Vector(this.pos.x-4,this.pos.y+8+n)):!1},this.use=function(n,t){for(var u=currentLevel.getEntities(n,t),i=0,r;i<u.length;){if(r=u[i],r!=this&&r.use(this.attackDir))return!0;i+=1}return!1}}function trySpawn(n){while(n>0){var t,r=new Vector(0,0),i;i=currentLevelDepth<0?4:parseInt(Math.random()*(currentLevelDepth+1))+1,t=Math.random()<.5?new Slime(r,i):new Zombie(r,i),t.findStartPos()&&currentLevel.add(t),n-=1}}function setGameState(n,t){var e=gameState,r,o,f;if(gameState=n,gameState==0&&(document.getElementById("frame").style.display="none",removeAllSprites(),drawTitleScreen()),gameState==1&&(removeAllSprites(),drawHowToPlayScreen()),gameState==2)return window.open("http://funhtml5games.com","_blank"),gameState=0;if(gameState==3&&t==!0){if(!/\d/.test(location.host) && false)return;levelList=[],startTime=+new Date,removeAllSprites(!1),removeAllSprites(!0),drawFont("Generating",new Vector(8,8),2),drawFont("terrain...",new Vector(8,16),2),hasScheduledTerrainGeneration=!0}if(e==4|e==5|e==6|e==7|e==8|e==9){for(removeSpriteGroup(currentMenuFrame),removeSpriteGroup(currentMenuFrameCursor),r=0;r<currentMenuFrameInfoList.length;)removeSpriteGroup(currentMenuFrameInfoList[r]),r+=1;for(r=0;r<secondaryMenuFrameInfoList.length;)removeSpriteGroup(secondaryMenuFrameInfoList[r]),r+=1;secondaryMenuFrameInfoList=[]}if(gameState==4&&(currentMenuFrame=drawMenuFrame("INVENTORY",new Vector(8,8),new Vector(96,88)),currentMenuFrameCursor=drawMenuFrameCursor(new Vector(8,16),new Vector(96,16)),currentMenuFrameCursorIndex=0,currentMenuFrameObjectList=currentPlayer.inventory.items,currentMenuFrameInfoList=drawMenuFrameItemList(new Vector(16,16),currentMenuFrameObjectList,0)),gameState==5&&(currentMenuFrameObjectList=workbenchRecipeSet),gameState==6&&(currentMenuFrameObjectList=furnaceRecipeSet),gameState==7&&(currentMenuFrameObjectList=ovenRecipeSet),gameState==8&&(currentMenuFrameObjectList=anvilRecipeSet),gameState==5|gameState==6|gameState==7|gameState==8&&(updateRecipeSetCanCraftValues(currentMenuFrameObjectList),currentMenuFrame=drawMenuFrame("CRAFTING",new Vector(0,8),new Vector(88,88)),o=drawMenuFrame("HAVE",new Vector(96,8),new Vector(152,24)),concatenateLists(currentMenuFrame,o),o=drawMenuFrame("COST",new Vector(96,32),new Vector(152,88)),concatenateLists(currentMenuFrame,o),currentMenuFrameCursor=drawMenuFrameCursor(new Vector(0,16),new Vector(88,16)),currentMenuFrameCursorIndex=0,currentMenuFrameInfoList=drawMenuFrameItemList(new Vector(8,16),currentMenuFrameObjectList,0),redrawSecondaryMenuFrameInfo()),gameState==9&&(currentMenuFramePosition=0,currentMenuFrame=drawMenuFrame("CHEST",new Vector(8,8),new Vector(96,88)),o=drawMenuFrame("INVENTORY",new Vector(104,8),new Vector(192,88)),concatenateLists(currentMenuFrame,o),currentMenuFrameCursor=drawMenuFrameCursor(new Vector(8,16),new Vector(96,16)),currentMenuFrameCursorIndex=0,currentMenuFrameInfoList=drawMenuFrameItemList(new Vector(16,16),currentMenuFrameObjectList,0),secondaryMenuFrameObjectList=currentPlayer.inventory.items,redrawSecondaryMenuFrameInfo()),gameState==10&&(changeLevelDelay=0),gameState==11){currentMenuFrame=drawMenuFrame("",new Vector(8,24),new Vector(144,72)),drawFont("You died! Aww!",new Vector(16,32),0);var u=parseInt((+new Date-startTime)/1e3),i=parseInt(u/60),s=parseInt(i/60);i%=60,u%=60,f="",f=s>0?s+"h"+(i<10?"0":"")+i+"m":i+"m "+(u<10?"0":"")+u+"s",drawFont("Time:",new Vector(16,40),0),drawFont(f,new Vector(56,40),5),drawFont("Score:",new Vector(16,48),0),drawFont(currentPlayer.score+"",new Vector(64,48),5),drawFont("Press C to retry",new Vector(16,64),2)}if(gameState==12){currentMenuFrame=drawMenuFrame("",new Vector(8,24),new Vector(144,72)),drawFont("You won! Yay!",new Vector(16,32),0);var u=parseInt((+new Date-startTime)/1e3),i=parseInt(u/60),s=parseInt(i/60);i%=60,u%=60,f="",f=s>0?s+"h"+(i<10?"0":"")+i+"m":i+"m "+(u<10?"0":"")+u+"s",drawFont("Time:",new Vector(16,40),0),drawFont(f,new Vector(56,40),5),drawFont("Score:",new Vector(16,48),0),drawFont(currentPlayer.score+"",new Vector(64,48),5),drawFont("Press C to win",new Vector(16,64),2)}}function drawGui(){for(var n=0,t;n<currentPlayer.maxHealth;)t=new Vector(n*8,screenDim.y-16),guiSpriteList.push(addSprite(new Vector(1,1),t,388,[0,1,1,1])),n+=1;for(n=0;n<currentPlayer.maxStamina;)t=new Vector(n*8,screenDim.y-8),guiSpriteList.push(addSprite(new Vector(1,1),t,389,[0,1,1,1])),n+=1}function updateGuiSprites(){for(var n=0,u,r,t,i;n<currentPlayer.maxHealth;)t=n<currentPlayer.health?0:1,i=guiSpriteList[n],setSpriteColorNumberLust(i,t),n+=1;for(u=currentPlayer.stamina<1&&Math.abs(currentPlayer.staminaRechargeDelay)%2<1,r=n;n<r+currentPlayer.maxStamina;)t=n-r<currentPlayer.stamina?0:u?2:1,i=guiSpriteList[n],setSpriteColorNumberLust(i,t),n+=1}function drawMenuOption(n){var t,i,u,r;return menuOptionSpriteGroups[n]!=undefined&&removeSpriteGroup(menuOptionSpriteGroups[n]),t=menuOptionTextSet[n],i=2,n==selectedMenuOptionIndex&&(t="> "+t+" <",i=0),u=new Vector(parseInt((screenDim.x-t.length*8)/2),(8+n)*8),r=drawFont(t,u,i),menuOptionSpriteGroups[n]=r,r}function drawTitleScreen(){addSprite(new Vector(13,2),new Vector(28,24),192,0);for(var n=0;n<menuOptionTextSet.length;)drawMenuOption(n),n+=1;drawFont("(Arrow keys,X and C)",new Vector(0,screenDim.y-8),3)}function drawHowToPlayScreen(){var t=["Move your character","with the arrow keys","press C to attack","and X to open the","inventory and to","use items.","Select an item in","the inventory to","equip it.","Kill the air wizard","to win the game!"],n;for(drawFont("HOW TO PLAY",new Vector(36,8),0),n=0;n<11;)drawFont(t[n],new Vector(4,(n+3)*8),2),n+=1}function convertKeyCodeToAlternativeControls(n){return n==87&&(n=38),n==83&&(n=40),n==65&&(n=37),n==68&&(n=39),n==13&&(n=88),n}function DummyEvent(n){this.which=n}function timerEvent(){var e,r,o,s,u,h,f,n,i,t;if(frameNumber+=1,setGameStateDelay>0&&(setGameStateDelay-=1,setGameStateDelay<=0&&setGameState(nextGameState)),gameState==3){if(hasScheduledTerrainGeneration==!0){for(hasScheduledTerrainGeneration=!1,removeAllSprites(!1),visibleTileList=[],document.getElementById("frame").style.display="block",levelList[-1]=new Level(createAndValidateSkyMap(),-1),levelList[0]=new Level(createAndValidateTopMap(0),0,levelList[-1]),currentLevelDepth=0,currentLevel=levelList[currentLevelDepth],n=new Player(new Vector(20,20));;)if(n.findStartPos())break;return currentLevel.add(n),cameraPos=getTargetCameraPos(),currentLevel.draw(),drawGui(),!0}for(updateLighting(),r=new Vector(0,tilePosYToProcess);r.x<levelDim.x*16;)u=currentLevel.getTileObject(r),u.tick(r),r.x+=16;for(tilePosYToProcess+=16,tilePosYToProcess>levelDim.y*16&&(tilePosYToProcess=0),trySpawn(1),e=currentLevel.entities.slice(),i=0;i<e.length;)n=e[i],n.isDead||n.tick(),n.isDead||(r=new Vector(n.pos.x-cameraPos.x,n.pos.y-cameraPos.y),o=r.x+8>0&&r.x-8<screenDim.x&&r.y+11>0&&r.y-11<screenDim.y,n.removed?o&&n.draw():o||n.remove(),s=1e3,n.zIndexPriority<2&&(s=n.pos.y+100),setSpriteGroupZIndex(n.spriteGroup,s)),i+=1;for(i=0;i<visibleTileList.length;){if(u=visibleTileList[i],u.onscreenTick(),frameNumber%10==parseInt(u.pos.x/16)%10)for(h=currentLevel.getEntities(u.pos,new Vector(u.pos.x+15,u.pos.y+15)),f=0;f<h.length;)n=h[f],n.isDead&&n.die(),f+=1;i+=1}updateGuiSprites()}if(gameState==10){for(changeLevelDelay+=1,updateLighting(),i=0,t=new Vector(0,0);t.y<screenDim.y-16;)changeLevelOffset<0?t.y+t.x/2+t.x%16>(changeLevelDelay-13)*16&&t.y+t.x/2-t.x%16<changeLevelDelay*16&&setLightingBackground(i,0):t.y+t.x/2+t.x%16>(13-changeLevelDelay)*16&&t.y+t.x/2-t.x%16<(26-changeLevelDelay)*16&&setLightingBackground(i,0),i+=1,t.x+=8,t.x>screenDim.x-1&&(t.x=0,t.y+=8);changeLevelDelay==13&&changeLevel(changeLevelOffset),changeLevelDelay>26&&setGameState(3)}}function init(){var i,r,t,n;for(window.focus(),i=0;i<7;)audioPlayerSet.push(document.getElementById("audioPlayer"+i)),i+=1;for(r=document.getElementById("lightingDiv"),t=new Vector(0,0);t.y<screenDim.y-16;)n=document.createElement("div"),r.appendChild(n),n.style.width=8*pixelSize+"px",n.style.height=8*pixelSize+"px",n.style.position="absolute",n.style.left=t.x*pixelSize+"px",n.style.top=t.y*pixelSize+"px",n.style.display="none",lightingSet.push(n),lightingValueList.push(4),t.x+=8,t.x>screenDim.x-1&&(t.x=0,t.y+=8);setGameState(0),setInterval("timerEvent()",220/frameRate),isOnMobileDevice&&(document.getElementById("dpad").style.display="block")}function leftClick(n){return window.focus(),n||(n=event),typeof n.which=="undefined"?n.button==1:n.which==1||n.button==0}function nrc(n){if(leftClick(n)==!1)return ce(n)}function cp(n){n||(n=event),n.stopPropagation?n.stopPropagation():typeof n.cancelBubble!="undefined"&&(n.cancelBubble=!0)}function ce(n){return n||(n=window.event),typeof n.preventDefault!="undefined"?n.preventDefault():typeof n.cancelBubble!="undefined"&&(n.returnValue=0,n.cancelBubble=!0),!1}var isOnMobileDevice,frameRate,g,b,characterSet,tileObjectSet,cameraPos,tileEdgeOffsetList,visibleEntityList,resourceSet,toolTypeSet,currentAirWizard,currentPlayer,guiSpriteList,screenDim,keyIsHeld,index,tilePosYToProcess,frameNumber;typeof document.oncontextmenu!="undefined"?document.oncontextmenu=ce:document.onclick=nrc,typeof document.onselectstart!="undefined"&&(document.onselectstart=ce),typeof document.ondragstart!="undefined"&&(document.ondragstart=ce),isOnMobileDevice=navigator.userAgent.indexOf("Mobile")!=-1,frameRate=3;for(var pixelSize=3,colorSet=[],r=0;r<6;){for(g=0;g<6;){for(b=0;b<6;){var rr=r*51,gg=g*51,bb=b*51,mid=(rr*30+gg*59+bb*11)/100,r2=(rr+mid*1)*115/255+10,g2=(gg+mid*1)*115/255+10,b2=(bb+mid*1)*115/255+10;colorSet[r*100+g*10+b]=new Color(parseInt(r2),parseInt(g2),parseInt(b2)),b+=1}g+=1}r+=1}characterSet="ABCDEFGHIJKLMNOPQRSTUVWXYZ      0123456789.,!?'\"-+=/\\%()<>:;";var sandColorNumber=550,dirtColorNumber=322,grassColorNumber=141;inheritFromClass(BoundaryTile,Tile),inheritFromClass(CactusTile,Tile),inheritFromClass(GrassTile,Tile),inheritFromClass(RockTile,Tile),inheritFromClass(SandTile,Tile),inheritFromClass(WaterTile,Tile),inheritFromClass(FlowerTile,Tile),inheritFromClass(TreeTile,Tile),inheritFromClass(DirtTile,Tile),inheritFromClass(HoleTile,Tile),inheritFromClass(TreeSaplingTile,Tile),inheritFromClass(CactusSaplingTile,Tile),inheritFromClass(FarmTile,Tile),inheritFromClass(WheatTile,Tile),inheritFromClass(LavaTile,Tile),inheritFromClass(StairsDownTile,Tile),inheritFromClass(StairsUpTile,Tile),inheritFromClass(InfiniteFallTile,Tile),inheritFromClass(CloudTile,Tile),inheritFromClass(HardRockTile,Tile),inheritFromClass(IronOreTile,Tile),inheritFromClass(GoldOreTile,Tile),inheritFromClass(GemOreTile,Tile),inheritFromClass(CloudCactusTile,Tile),tileObjectSet=[new GrassTile,new RockTile,new WaterTile,new FlowerTile,new TreeTile,new DirtTile,new SandTile,new CactusTile,new HoleTile,new TreeSaplingTile,new CactusSaplingTile,new FarmTile,new WheatTile,new LavaTile,new StairsDownTile,new StairsUpTile,new InfiniteFallTile,new CloudTile,new HardRockTile,new IronOreTile,new GoldOreTile,new GemOreTile,new CloudCactusTile],tileObjectSet[-1]=new BoundaryTile,cameraPos=new Vector(0,0);var levelDim=new Vector(128,128),levelList=[],currentLevel,currentLevelDepth,visibleTileList=[];tileEdgeOffsetList=[0,0,8,0],visibleEntityList=[],inheritFromClass(TextParticle,Entity),inheritFromClass(Spark,Entity),inheritFromClass(SmashParticle,Entity),inheritFromClass(ItemEntity,Entity),inheritFromClass(PowerGloveItem,Item),inheritFromClass(ResourceItem,Item),inheritFromClass(PlantableResource,Resource),inheritFromClass(FoodResource,Resource),resourceSet=[new Resource("Wood",129,0),new Resource("Stone",130,0),new PlantableResource("Flower",128,0,3,[0]),new PlantableResource("Acorn",131,0,9,[0]),new PlantableResource("Dirt",130,1,5,[8,2,13]),new PlantableResource("Sand",130,2,6,[0,5]),new PlantableResource("Cactus",132,0,10,[6]),new PlantableResource("Seeds",133,0,12,[11]),new Resource("Wheat",134,0),new FoodResource("Bread",136,0,2,5),new FoodResource("Apple",137,0,1,5),new Resource("COAL",138,0),new Resource("I.ORE",138,2),new Resource("G.ORE",138,3),new Resource("IRON",139,0),new Resource("GOLD",139,1),new Resource("SLIME",138,1),new Resource("glass",140,0),new Resource("cloth",129,1),new PlantableResource("cloud",130,3,17,[16]),new Resource("gem",141,0)],inheritFromClass(FurnitureItem,Item),inheritFromClass(Furniture,Entity),inheritFromClass(Workbench,Furniture),inheritFromClass(Furnace,Furniture),inheritFromClass(Oven,Furniture),inheritFromClass(Anvil,Furniture),inheritFromClass(Chest,Furniture),inheritFromClass(Lantern,Furniture);var toolMaxLevel=5,toolLevelNameSet=["Wood","Rock","Iron","Gold","Gem"],toolLevelColorNumberLustSet=[0,1,2,3,4];inheritFromClass(ToolItem,Item),toolTypeSet=[new ToolType("Shvl",0),new ToolType("Hoe",1),new ToolType("Swrd",2),new ToolType("Pick",3),new ToolType("Axe",4)],inheritFromClass(ToolRecipe,Recipe),inheritFromClass(FurnitureRecipe,Recipe),inheritFromClass(ResourceRecipe,Recipe);var workbenchRecipeSet=[new FurnitureRecipe(Workbench).addCost(resourceSet[0],20),new FurnitureRecipe(Lantern).addCost(resourceSet[0],5).addCost(resourceSet[16],10).addCost(resourceSet[17],4),new FurnitureRecipe(Furnace).addCost(resourceSet[1],20),new FurnitureRecipe(Oven).addCost(resourceSet[1],15),new FurnitureRecipe(Anvil).addCost(resourceSet[14],5),new FurnitureRecipe(Chest).addCost(resourceSet[0],20),new ToolRecipe(toolTypeSet[2],0).addCost(resourceSet[0],5),new ToolRecipe(toolTypeSet[4],0).addCost(resourceSet[0],5),new ToolRecipe(toolTypeSet[1],0).addCost(resourceSet[0],5),new ToolRecipe(toolTypeSet[3],0).addCost(resourceSet[0],5),new ToolRecipe(toolTypeSet[0],0).addCost(resourceSet[0],5),new ToolRecipe(toolTypeSet[2],1).addCost(resourceSet[0],5).addCost(resourceSet[1],5),new ToolRecipe(toolTypeSet[4],1).addCost(resourceSet[0],5).addCost(resourceSet[1],5),new ToolRecipe(toolTypeSet[1],1).addCost(resourceSet[0],5).addCost(resourceSet[1],5),new ToolRecipe(toolTypeSet[3],1).addCost(resourceSet[0],5).addCost(resourceSet[1],5),new ToolRecipe(toolTypeSet[0],1).addCost(resourceSet[0],5).addCost(resourceSet[1],5)],furnaceRecipeSet=[new ResourceRecipe(resourceSet[14]).addCost(resourceSet[12],4).addCost(resourceSet[11],1),new ResourceRecipe(resourceSet[15]).addCost(resourceSet[13],4).addCost(resourceSet[11],1),new ResourceRecipe(resourceSet[17]).addCost(resourceSet[5],4).addCost(resourceSet[11],1)],ovenRecipeSet=[new ResourceRecipe(resourceSet[9]).addCost(resourceSet[8],4)],anvilRecipeSet=[new ToolRecipe(toolTypeSet[2],2).addCost(resourceSet[0],5).addCost(resourceSet[14],5),new ToolRecipe(toolTypeSet[4],2).addCost(resourceSet[0],5).addCost(resourceSet[14],5),new ToolRecipe(toolTypeSet[1],2).addCost(resourceSet[0],5).addCost(resourceSet[14],5),new ToolRecipe(toolTypeSet[3],2).addCost(resourceSet[0],5).addCost(resourceSet[14],5),new ToolRecipe(toolTypeSet[0],2).addCost(resourceSet[0],5).addCost(resourceSet[14],5),new ToolRecipe(toolTypeSet[2],3).addCost(resourceSet[0],5).addCost(resourceSet[15],5),new ToolRecipe(toolTypeSet[4],3).addCost(resourceSet[0],5).addCost(resourceSet[15],5),new ToolRecipe(toolTypeSet[1],3).addCost(resourceSet[0],5).addCost(resourceSet[15],5),new ToolRecipe(toolTypeSet[3],3).addCost(resourceSet[0],5).addCost(resourceSet[15],5),new ToolRecipe(toolTypeSet[0],3).addCost(resourceSet[0],5).addCost(resourceSet[15],5),new ToolRecipe(toolTypeSet[2],4).addCost(resourceSet[0],5).addCost(resourceSet[20],50),new ToolRecipe(toolTypeSet[4],4).addCost(resourceSet[0],5).addCost(resourceSet[20],50),new ToolRecipe(toolTypeSet[1],4).addCost(resourceSet[0],5).addCost(resourceSet[20],50),new ToolRecipe(toolTypeSet[3],4).addCost(resourceSet[0],5).addCost(resourceSet[20],50),new ToolRecipe(toolTypeSet[0],4).addCost(resourceSet[0],5).addCost(resourceSet[20],50)];inheritFromClass(Mob,Entity),inheritFromClass(Slime,Mob),inheritFromClass(Zombie,Mob),inheritFromClass(AirWizard,Mob),inheritFromClass(Player,Mob);var gameState=-1,currentMenuFrame=-1,currentMenuFrameCursor=-1,currentMenuFrameCursorIndex=-1,currentMenuFrameInfoList=[],currentMenuFrameObjectList=[],secondaryMenuFrameInfoList=[],secondaryMenuFrameObjectList=[],currentMenuFramePosition=0,currentEquippedItemInfo=[],changeLevelDelay=0,changeLevelOffset=0,hasScheduledTerrainGeneration=!1,setGameStateDelay=-1,nextGameState=-1,startTime=-1;guiSpriteList=[],screenDim=new Vector(160,120);var menuOptionSpriteGroups=[],menuOptionTextSet=["Start game","How to play"],selectedMenuOptionIndex=0;for(keyIsHeld=[],index=0;index<256;)keyIsHeld[index]=!1,index+=1;document.onkeydown=function(n){return document.keyDown(n)},document.keyDown=function(n){var t=n.which||n.keyCode,r,u,f,e,o,i;if(t=convertKeyCodeToAlternativeControls(t),keyIsHeld[t]=!0,gameState==0&&(t==38&&(r=selectedMenuOptionIndex,selectedMenuOptionIndex-=1,selectedMenuOptionIndex<0&&(selectedMenuOptionIndex+=menuOptionTextSet.length),drawMenuOption(r),drawMenuOption(selectedMenuOptionIndex)),t==40&&(r=selectedMenuOptionIndex,selectedMenuOptionIndex+=1,selectedMenuOptionIndex>menuOptionTextSet.length-1&&(selectedMenuOptionIndex-=menuOptionTextSet.length),drawMenuOption(r),drawMenuOption(selectedMenuOptionIndex)),t==88|t==67&&(selectedMenuOptionIndex==0&&(playSound(6),setGameState(3,!0),t=-1),selectedMenuOptionIndex==1&&(setGameState(1),t=-1),selectedMenuOptionIndex==2&&(setGameState(2),t=-1))),gameState==1|gameState==2&&t==88|t==67&&(setGameState(0),t=-1),gameState==3&&!hasScheduledTerrainGeneration){if(currentPlayer.isDead)return!0;t==67&&currentPlayer.attack(),t==88&&(currentPlayer.useInCurrentDir()||setGameState(4),t=-1)}if(gameState==4&&(t==38&&moveMenuFrameCursor(new Vector(8,16),-1),t==40&&moveMenuFrameCursor(new Vector(8,16),1),t==67&&(e=currentPlayer.inventory.items[currentMenuFrameCursorIndex],currentPlayer.equip(e,currentMenuFrameCursorIndex)),t==88&&currentPlayer.equip(-1,0),t==67|t==88&&(setGameState(3),t=-1)),gameState==5|gameState==6|gameState==7|gameState==8){if(t==38&&(moveMenuFrameCursor(new Vector(0,16),-1),redrawSecondaryMenuFrameInfo()),t==40&&(moveMenuFrameCursor(new Vector(0,16),1),redrawSecondaryMenuFrameInfo()),t==67&&(u=currentMenuFrameObjectList[currentMenuFrameCursorIndex],u.canCraft)){for(u.deductCost(),u.craft(),f=0;f<currentMenuFrameInfoList.length;)removeSpriteGroup(currentMenuFrameInfoList[f]),f+=1;updateRecipeSetCanCraftValues(currentMenuFrameObjectList),currentMenuFrameInfoList=drawMenuFrameItemList(new Vector(8,16),currentMenuFrameObjectList,currentMenuFrameCursorIndex),redrawSecondaryMenuFrameInfo()}t==88&&(setGameState(3),t=-1)}return(gameState==9&&(i=8,currentMenuFramePosition==1&&(i=56),t==38&&moveMenuFrameCursor(new Vector(i,16),-1),t==40&&moveMenuFrameCursor(new Vector(i,16),1),t==37&&currentMenuFramePosition==1&&swapSecondaryMenuFrame(),t==39&&currentMenuFramePosition==0&&swapSecondaryMenuFrame(),t==67&&currentMenuFrameObjectList.length>0&&(e=currentMenuFrameObjectList[currentMenuFrameCursorIndex],currentMenuFrameObjectList.splice(currentMenuFrameCursorIndex,1),o=new Inventory,o.items=secondaryMenuFrameObjectList,o.add(e),secondaryMenuFrameObjectList=o.items,currentMenuFrameCursorIndex>currentMenuFrameObjectList.length-1&&(currentMenuFrameCursorIndex=currentMenuFrameObjectList.length-1,i=8,currentMenuFramePosition==1&&(i=56)),moveMenuFrameCursor(new Vector(i,16),0),redrawCurrentMenuFrameInfo(),redrawSecondaryMenuFrameInfo()),t==88&&(setGameState(3),t=-1)),gameState==11|gameState==12&&(t==67&&setGameState(0),t==88))?!0:t>36&&t<41?!1:void 0},document.onkeyup=function(n){return document.keyUp(n)},document.keyUp=function(n){var t=n.which||n.keyCode;t=convertKeyCodeToAlternativeControls(t),keyIsHeld[t]=!1},tilePosYToProcess=0,frameNumber=0;var audioPlayerSet=[],lightingSet=[],lightingValueList=[]